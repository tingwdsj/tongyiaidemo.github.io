<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AIäº§å“ä¸“å®¶ - æ™ºèƒ½æ¶¦æ»‘æ²¹å’¨è¯¢åŠ©æ‰‹">
    <meta name="theme-color" content="#4d6bfe">
    <title>AIäº§å“ä¸“å®¶</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app">
        <!-- ç™»å½•é¡µé¢ -->
        <div id="login-page" class="page active">
            <div class="login-container">
                <div class="login-content">
                    <div class="brand-section">
                        <img src="assets/images/logo.png" alt="AIäº§å“ä¸“å®¶" class="brand-logo">
                        <h1 class="brand-title">AIäº§å“ä¸“å®¶</h1>
                        <p class="brand-subtitle">æ‚¨çš„æ™ºèƒ½æ¶¦æ»‘æ²¹å’¨è¯¢åŠ©æ‰‹</p>
                    </div>

                    <div class="login-actions">
                        <button class="login-btn primary" id="wechat-login-btn">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 4.882-1.786 7.267-.736-.847-3.206-4.468-5.49-8.91-5.49z"/>
                                <path d="M15.309 9.53c-4.337 0-7.891 2.746-7.891 6.053 0 3.307 3.554 6.053 7.891 6.053.875 0 1.713-.144 2.484-.398a.7.7 0 0 1 .832.232l1.521 1.114a.253.253 0 0 0 .147.043c.12 0 .217-.1.217-.225 0-.06-.023-.12-.038-.177l-.313-1.332a.427.427 0 0 1 .154-.485c1.724-1.224 2.887-2.998 2.887-5.025 0-3.307-3.554-6.053-7.891-6.053z"/>
                            </svg>
                            å¾®ä¿¡æ‰«ç ç™»å½•
                        </button>
                        <button class="login-btn secondary" id="dingtalk-login-btn">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            é’‰é’‰æ‰«ç ç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div id="main-page" class="page">
            <!-- å·¦ä¾§åŠŸèƒ½åŒº -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="brand-info">
                        <img src="assets/images/logo.png" alt="AIäº§å“ä¸“å®¶" class="brand-logo">
                        <span class="brand-text">AIäº§å“ä¸“å®¶</span>
                    </div>
                    <div class="header-actions">
                        <button class="new-chat-btn-mini" id="new-chat-btn-mini" style="display: none;">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </button>
                        <button class="sidebar-toggle" id="sidebar-toggle">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12h18M3 6h18M3 18h18"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="sidebar-content">
                    <button class="new-chat-btn" id="new-chat-btn">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        æ–°å»ºå¯¹è¯
                    </button>

                    <div class="chat-history">
                        <div class="history-header">
                            <h3>å†å²æ–¹æ¡ˆåº“</h3>
                        </div>
                        <div class="history-list" id="history-list">
                            <!-- å†å²å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <div class="user-menu">
                        <button class="user-btn" id="user-menu-btn">
                            <div class="user-avatar">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <span class="user-name" id="user-name">Simon</span>
                            <svg class="icon dropdown" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="user-dropdown">
                            <button class="dropdown-item" id="feedback-btn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                                åé¦ˆä¸å¸®åŠ©
                            </button>
                            <button class="dropdown-item" id="logout-btn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                                </svg>
                                é€€å‡ºç™»å½•
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <main class="main-content">
                <!-- é¡¶éƒ¨èœå•æ  -->
                <header class="top-header" id="top-header">
                    <div class="top-header-left">
                        <div class="brand-info">
                            <img src="assets/images/logo.png" alt="AIäº§å“ä¸“å®¶" class="brand-logo">
                            <span class="brand-text">AIäº§å“ä¸“å®¶</span>
                        </div>
                        <button class="combined-action-btn" id="combined-action-btn">
                            <svg class="icon expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12h18M3 6h18M3 18h18"/>
                            </svg>
                            <svg class="icon new-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </button>
                    </div>
                    <div class="top-header-actions">
                        <!-- å³ä¾§å…¶ä»–æ“ä½œæŒ‰é’®å¯ä»¥æ”¾åœ¨è¿™é‡Œ -->
                    </div>
                </header>
                <!-- æ¬¢è¿ç•Œé¢ -->
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-content">
                        <div class="welcome-text-container">
                            <div class="welcome-text">
                                <img src="assets/images/logo.png" alt="AIäº§å“ä¸“å®¶" class="welcome-logo">
                                <h2 class="typing-text" id="welcome-text"></h2>
                            </div>
                            <!-- å“ç‰ŒIPå½¢è±¡ -->
                            <div class="brand-mascot">
                                <img src="assets/images/mascot.gif" alt="å®‰å®‰" class="mascot-image">
                            </div>
                        </div>

                        <!-- æ–°çš„è¾“å…¥æ¡† - ä¸å¿«æ·å¡ç‰‡ä¸€ä½“ -->
                        <div class="welcome-input-container">
                            <div class="welcome-input-wrapper">
                                <textarea
                                    class="welcome-message-input"
                                    id="welcome-message-input"
                                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"
                                    rows="2"
                                ></textarea>
                                <div class="welcome-input-actions">
                                    <label class="welcome-deep-thinking-toggle">
                                        <input type="checkbox" id="welcome-deep-thinking-checkbox">
                                        <span class="toggle-label">æ·±åº¦æ€è€ƒ</span>
                                    </label>
                                    <button class="welcome-send-btn" id="welcome-send-btn">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="task-cards">
                            <div class="task-card" data-task="product-query">
                                <div class="card-icon">ğŸ”</div>
                                <div class="task-card-content">
                                    <h3>äº§å“å‚æ•°é€ŸæŸ¥</h3>
                                    <p>å¿«é€ŸæŸ¥è¯¢æ¶¦æ»‘æ²¹äº§å“æŠ€æœ¯å‚æ•°å’Œè§„æ ¼ä¿¡æ¯</p>
                                </div>
                            </div>
                            <div class="task-card" data-task="competitor-comparison">
                                <div class="card-icon">ğŸ“Š</div>
                                <div class="task-card-content">
                                    <h3>ç”Ÿæˆç«å“å¯¹æ¯”è¡¨</h3>
                                    <p>å¯¹æ¯”ä¸åŒå“ç‰Œäº§å“çš„æ€§èƒ½å’Œç‰¹ç‚¹</p>
                                </div>
                            </div>
                            <div class="task-card" data-task="scenario-solution">
                                <div class="card-icon">ğŸ­</div>
                                <div class="task-card-content">
                                    <h3>åˆ›å»ºåœºæ™¯æ–¹æ¡ˆ</h3>
                                    <p>é’ˆå¯¹å…·ä½“å·¥å†µæä¾›æ¶¦æ»‘è§£å†³æ–¹æ¡ˆ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- èŠå¤©ç•Œé¢ -->
                <div class="chat-container" id="chat-container">
                    <div class="messages-area" id="messages-area">
                        <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-area">
                    <div class="quick-actions" id="quick-actions">
                        <!-- å¿«æ·ä»»åŠ¡æŒ‰é’® -->
                    </div>
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea
                                class="message-input"
                                id="message-input"
                                placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"
                                rows="2"
                            ></textarea>
                            <div class="input-actions">
                                <label class="deep-thinking-toggle">
                                    <input type="checkbox" id="deep-thinking-checkbox">
                                    <span class="toggle-label">æ·±åº¦æ€è€ƒ</span>
                                </label>
                                <button class="send-btn" id="send-btn">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- æ¨¡æ€å¼¹çª— -->
        <div class="modal-overlay" id="modal-overlay">
            <!-- å¼¹çª—å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // å†…è”æ‰€æœ‰JavaScriptä»£ç 
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        class AppState {
            constructor() {
                this.currentPage = 'login';
                this.userName = 'Simon';
                this.isLoggedIn = false;
                this.currentChatId = null;
                this.chatHistory = [];
                this.sidebarCollapsed = false;
                this.deepThinkingEnabled = false;
                this.welcomeText = '';
                this.welcomeIndex = 0;
                this.isTyping = false;
            }

            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            saveState() {
                try {
                    const state = {
                        userName: this.userName,
                        isLoggedIn: this.isLoggedIn,
                        chatHistory: this.chatHistory,
                        currentChatId: this.currentChatId
                    };
                    localStorage.setItem('aiProductExpertState', JSON.stringify(state));
                } catch (error) {
                    console.warn('æ— æ³•ä¿å­˜åˆ°localStorage:', error);
                    // åœ¨localStorageä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨
                    this.tempState = {
                        userName: this.userName,
                        isLoggedIn: this.isLoggedIn,
                        chatHistory: this.chatHistory,
                        currentChatId: this.currentChatId
                    };
                }
            }

            // ä»localStorageåŠ è½½çŠ¶æ€
            loadState() {
                try {
                    const savedState = localStorage.getItem('aiProductExpertState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        Object.assign(this, state);
                    }
                } catch (error) {
                    console.warn('æ— æ³•ä»localStorageåŠ è½½çŠ¶æ€:', error);
                    // å°è¯•ä»ä¸´æ—¶çŠ¶æ€æ¢å¤
                    if (this.tempState) {
                        Object.assign(this, this.tempState);
                    }
                }
            }

            // æ¸…é™¤çŠ¶æ€
            clearState() {
                try {
                    localStorage.removeItem('aiProductExpertState');
                } catch (error) {
                    console.warn('æ— æ³•æ¸…é™¤localStorage:', error);
                }
                this.tempState = null;
                this.userName = 'Simon';
                this.isLoggedIn = false;
                this.currentChatId = null;
                this.chatHistory = [];
            }
        }

        // å…¨å±€çŠ¶æ€å®ä¾‹
        const appState = new AppState();

        // å·¥å…·å‡½æ•°
        const utils = {
            // ç”Ÿæˆå”¯ä¸€ID
            generateId() {
                return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // æ ¼å¼åŒ–æ—¶é—´
            formatTime(date) {
                // ç¡®ä¿dateæ˜¯Dateå¯¹è±¡
                if (!(date instanceof Date)) {
                    date = new Date(date);
                }

                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    return 'æœªçŸ¥æ—¶é—´';
                }

                const now = new Date();
                const diff = now - date;

                if (diff < 60000) {
                    return 'åˆšåˆš';
                } else if (diff < 3600000) {
                    return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
                } else if (diff < 86400000) {
                    return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
                } else {
                    return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                }
            },

            // é˜²æŠ–å‡½æ•°
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // æ˜¾ç¤ºToasté€šçŸ¥
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    utils.showToast('å¤åˆ¶æˆåŠŸ', 'success');
                } catch (err) {
                    // é™çº§æ–¹æ¡ˆ
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    utils.showToast('å¤åˆ¶æˆåŠŸ', 'success');
                }
            },

            // è½¬ä¹‰HTML
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            },

            // ç®€å•çš„Markdownè§£æå‡½æ•°
            parseMarkdown(text) {
                if (!text) return '';

                let html = text;

                // å¤„ç†æ ‡é¢˜ (# ## ### ç­‰)
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                // å¤„ç†ç²—ä½“ **text**
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

                // å¤„ç†æ–œä½“ *text*
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

                // å¤„ç†ä»£ç å— `code`
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

                // å¤„ç†æ— åºåˆ—è¡¨ - item
                html = html.replace(/^- (.+)$/gim, '<li>$1</li>');

                // å°†è¿ç»­çš„liåŒ…è£…åœ¨ulä¸­
                html = html.replace(/(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/g, '<ul>$&</ul>');

                // å¤„ç†æ¢è¡Œ
                html = html.replace(/\n\n/g, '</p><p>');
                html = html.replace(/\n/g, '<br>');

                // å¦‚æœä¸åŒ…å«HTMLæ ‡ç­¾ï¼ŒåŒ…è£…åœ¨æ®µè½ä¸­
                if (!html.includes('<h') && !html.includes('<ul>') && !html.includes('<p>')) {
                    html = '<p>' + html + '</p>';
                }

                return html;
            }
        };

        // æ‰“å­—æœºæ•ˆæœ
        class TypingEffect {
            constructor(element, text, speed = 120) {
                this.element = element;
                this.text = text;
                this.speed = speed;
                this.index = 0;
                this.isRunning = false;
                this.onComplete = null;
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.element.innerHTML = '';
                this.type();
            }

            type() {
                if (this.index < this.text.length) {
                    this.element.innerHTML = this.text.substring(0, this.index + 1) + '<span class="typing-cursor"></span>';
                    this.index++;
                    setTimeout(() => this.type(), this.speed);
                } else {
                    this.element.innerHTML = this.text;
                    this.isRunning = false;
                    if (this.onComplete) {
                        this.onComplete();
                    }
                }
            }

            stop() {
                this.isRunning = false;
            }
        }

        // å¯Œæ–‡æœ¬æ‰“å­—æœºæ•ˆæœï¼ˆæ”¯æŒMarkdownï¼‰
        class RichTextTypingEffect {
            constructor(element, markdownText, speed = 10) {
                this.element = element;
                this.originalText = markdownText;
                this.speed = speed;
                this.index = 0;
                this.isRunning = false;
                this.onComplete = null;
                this.htmlContent = utils.parseMarkdown(markdownText);
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.element.innerHTML = '';
                this.type();
            }

            type() {
                if (this.index < this.htmlContent.length) {
                    // å¤„ç†HTMLæ ‡ç­¾ï¼Œç¡®ä¿æ ‡ç­¾å®Œæ•´æ€§
                    let currentContent = this.htmlContent.substring(0, this.index + 1);

                    // ç¡®ä¿ä¸æˆªæ–­HTMLæ ‡ç­¾
                    const openTagCount = (currentContent.match(/</g) || []).length;
                    const closeTagCount = (currentContent.match(/>/g) || []).length;

                    if (openTagCount > closeTagCount) {
                        // å¦‚æœæ ‡ç­¾æœªé—­åˆï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªé—­åˆæ ‡ç­¾
                        const nextCloseTag = this.htmlContent.indexOf('>', this.index);
                        if (nextCloseTag !== -1) {
                            this.index = nextCloseTag;
                        }
                    }

                    this.element.innerHTML = this.htmlContent.substring(0, this.index + 1) + '<span class="typing-cursor"></span>';
                    this.index++;
                    setTimeout(() => this.type(), this.speed);
                } else {
                    this.element.innerHTML = this.htmlContent;
                    this.isRunning = false;
                    if (this.onComplete) {
                        this.onComplete();
                    }
                }
            }

            stop() {
                this.isRunning = false;
            }
        }

        // æ¨¡æ€æ¡†ç®¡ç†
        class ModalManager {
            constructor() {
                this.overlay = document.getElementById('modal-overlay');
                this.currentModal = null;
                this.init();
            }

            init() {
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.close();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.currentModal) {
                        this.close();
                    }
                });
            }

            show(content) {
                this.overlay.innerHTML = content;
                this.overlay.classList.add('show');
                this.currentModal = this.overlay.querySelector('.modal');
                this.bindEvents();
            }

            close() {
                this.overlay.classList.remove('show');
                this.currentModal = null;
            }

            bindEvents() {
                const closeBtn = this.overlay.querySelector('.modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.close());
                }

                const cancelBtns = this.overlay.querySelectorAll('.btn-secondary');
                cancelBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.close());
                });
            }
        }

        // ç™»å½•ç®¡ç†
        class LoginManager {
            constructor() {
                this.init();
            }

            init() {
                document.getElementById('wechat-login-btn').addEventListener('click', () => {
                    this.handleLogin('wechat');
                });

                document.getElementById('dingtalk-login-btn').addEventListener('click', () => {
                    this.handleLogin('dingtalk');
                });
            }

            handleLogin(provider) {
                // æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹
                const btn = provider === 'wechat' ?
                    document.getElementById('wechat-login-btn') :
                    document.getElementById('dingtalk-login-btn');

                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> ç™»å½•ä¸­...';

                setTimeout(() => {
                    appState.isLoggedIn = true;
                    appState.saveState();

                    utils.showToast(`ä½¿ç”¨${provider === 'wechat' ? 'å¾®ä¿¡' : 'é’‰é’‰'}ç™»å½•æˆåŠŸ`, 'success');

                    setTimeout(() => {
                        // åˆ‡æ¢åˆ°ä¸»ç•Œé¢
                        document.getElementById('login-page').classList.remove('active');
                        document.getElementById('main-page').classList.add('active');
                        document.getElementById('user-name').textContent = appState.userName;
                        utils.showToast('ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ä½¿ç”¨AIäº§å“ä¸“å®¶ï¼', 'success');

                        console.log('ğŸ”¥ ç™»å½•æˆåŠŸï¼Œå¼€å§‹å¤šé˜¶æ®µè®¾ç½®è¾“å…¥æ¡†ä½ç½®');

                        // å¤šé˜¶æ®µå¼ºåˆ¶è®¾ç½®è¾“å…¥æ¡†ä½ç½®ï¼Œç¡®ä¿ä¸è¢«è¦†ç›–
                        const setInputBoxPosition = () => {
                            const welcomeScreen = document.getElementById('welcome-screen');
                            const inputArea = document.querySelector('.input-area');

                            if (welcomeScreen) {
                                welcomeScreen.style.display = 'flex';
                                welcomeScreen.classList.add('active');
                                console.log('ğŸ”¥ è®¾ç½®æ¬¢è¿ç•Œé¢æ˜¾ç¤º');
                            }

                            if (inputArea) {
                                // ä½¿ç”¨æœ€å¼ºåˆ¶çš„æ–¹å¼è®¾ç½®æ ·å¼
                                inputArea.style.cssText = `
                                    margin-top: -250px !important;
                                    background-color: transparent !important;
                                    padding-top: 0 !important;
                                    padding-bottom: 0 !important;
                                    margin-bottom: 0 !important;
                                `;
                                console.log('ğŸ”¥ å¼ºåˆ¶è®¾ç½®è¾“å…¥æ¡†ä½ç½®: margin-top: -250px');
                            }
                        };

                        // ç«‹å³è®¾ç½®ä¸€æ¬¡
                        setInputBoxPosition();

                        // 300msåå†è®¾ç½®ä¸€æ¬¡
                        setTimeout(setInputBoxPosition, 300);

                        // 600msåå†è®¾ç½®ä¸€æ¬¡
                        setTimeout(setInputBoxPosition, 600);

                        // 1000msåå†è®¾ç½®ä¸€æ¬¡ï¼Œç¡®ä¿å®Œå…¨è¦†ç›–
                        setTimeout(setInputBoxPosition, 1000);

                        // è§¦å‘ä¸»ç•Œé¢åˆå§‹åŒ–
                        if (window.appManager) {
                            console.log('ğŸ”¥ ç™»å½•æˆåŠŸï¼Œè°ƒç”¨showMainPage');
                            window.appManager.showMainPage(false);
                        }
                    }, 1000);
                }, 1500);
            }
        }

        // èŠå¤©ç®¡ç†
        class ChatManager {
            constructor() {
                this.messagesContainer = document.getElementById('messages-area');
                this.messageInput = document.getElementById('message-input');
                this.sendBtn = document.getElementById('send-btn');
                this.deepThinkingCheckbox = document.getElementById('deep-thinking-checkbox');

                // æ–°å¢æ¬¢è¿ç•Œé¢çš„è¾“å…¥æ¡†å…ƒç´ 
                this.welcomeMessageInput = document.getElementById('welcome-message-input');
                this.welcomeSendBtn = document.getElementById('welcome-send-btn');
                this.welcomeDeepThinkingCheckbox = document.getElementById('welcome-deep-thinking-checkbox');

                this.currentTypingEffect = null;
                this.init();
            }

            init() {
                // åŸè¾“å…¥æ¡†äº‹ä»¶ç»‘å®š
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keydown', (e) => {
                    // Enter å‘é€æ¶ˆæ¯ï¼ŒShift+Enter æ¢è¡Œ
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                    // Shift+Enter å…è®¸æ¢è¡Œï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
                });

                this.messageInput.addEventListener('input', () => {
                    this.autoResize();
                });

                this.deepThinkingCheckbox.addEventListener('change', (e) => {
                    appState.deepThinkingEnabled = e.target.checked;
                });

                // æ–°å¢æ¬¢è¿ç•Œé¢è¾“å…¥æ¡†äº‹ä»¶ç»‘å®š
                if (this.welcomeSendBtn && this.welcomeMessageInput) {
                    this.welcomeSendBtn.addEventListener('click', () => this.sendMessageFromWelcome());
                    this.welcomeMessageInput.addEventListener('keydown', (e) => {
                        // Enter å‘é€æ¶ˆæ¯ï¼ŒShift+Enter æ¢è¡Œ
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessageFromWelcome();
                        }
                        // Shift+Enter å…è®¸æ¢è¡Œï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
                    });

                    this.welcomeMessageInput.addEventListener('input', () => {
                        this.autoResizeWelcome();
                    });

                    this.welcomeDeepThinkingCheckbox.addEventListener('change', (e) => {
                        appState.deepThinkingEnabled = e.target.checked;
                    });
                }
            }

            autoResize() {
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
            }

            autoResizeWelcome() {
                if (this.welcomeMessageInput) {
                    this.welcomeMessageInput.style.height = 'auto';
                    this.welcomeMessageInput.style.height = Math.min(this.welcomeMessageInput.scrollHeight, 180) + 'px'; // æ›´æ–°ä¸º180px
                }
            }

            async sendMessageFromWelcome() {
                console.log('ğŸ”¥ sendMessageFromWelcome å¼€å§‹æ‰§è¡Œ');
                const text = this.welcomeMessageInput.value.trim();
                console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢è¾“å…¥æ–‡æœ¬:', text);
                if (!text) {
                    console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢è¾“å…¥ä¸ºç©ºï¼Œé€€å‡º');
                    return;
                }

                // å°†æ–‡æœ¬å¤åˆ¶åˆ°åŸè¾“å…¥æ¡†å¹¶å‘é€
                this.messageInput.value = text;
                await this.sendMessage();

                // æ¸…ç©ºæ¬¢è¿ç•Œé¢è¾“å…¥æ¡†
                this.welcomeMessageInput.value = '';
                this.autoResizeWelcome();
            }

            async sendMessage() {
                console.log('ğŸ”¥ sendMessage å¼€å§‹æ‰§è¡Œ');
                const text = this.messageInput.value.trim();
                console.log('ğŸ”¥ è¾“å…¥æ–‡æœ¬:', text);
                if (!text) {
                    console.log('ğŸ”¥ è¾“å…¥ä¸ºç©ºï¼Œé€€å‡º');
                    return;
                }

                // åˆ›å»ºæˆ–è·å–å½“å‰èŠå¤©
                let isNewChat = false;
                console.log('ğŸ”¥ å½“å‰å¯¹è¯ID:', appState.currentChatId);
                if (!appState.currentChatId) {
                    console.log('ğŸ”¥ æ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯');
                    appState.currentChatId = utils.generateId();
                    const newChat = {
                        id: appState.currentChatId,
                        title: this.generateChatTitle(text),
                        messages: [],
                        createdAt: new Date()
                    };
                    appState.chatHistory.unshift(newChat);
                    // ç«‹å³ä¿å­˜æ–°åˆ›å»ºçš„å¯¹è¯
                    appState.saveState();
                    isNewChat = true;
                    console.log('ğŸ”¥ æ–°å¯¹è¯å·²åˆ›å»ºï¼ŒID:', appState.currentChatId);
                } else {
                    console.log('ğŸ”¥ å·²æœ‰å½“å‰å¯¹è¯ï¼Œä¸åˆ›å»ºæ–°å¯¹è¯');
                }

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                const userMessage = {
                    id: utils.generateId(),
                    role: 'user',
                    content: text,
                    timestamp: new Date()
                };

                // å¦‚æœæ˜¯æ–°åˆ›å»ºçš„å¯¹è¯ï¼Œæ›´æ–°ç•Œé¢çŠ¶æ€
                if (isNewChat) {
                    console.log('ğŸ”¥ åˆ›å»ºæ–°å¯¹è¯ï¼Œå¼€å§‹ç•Œé¢åˆ‡æ¢');
                    sidebarManager.hideWelcomeScreen();
                    console.log('ğŸ”¥ éšè—æ¬¢è¿ç•Œé¢å®Œæˆ');

                    sidebarManager.renderChatHistory();
                    console.log('ğŸ”¥ æ¸²æŸ“å†å²åˆ—è¡¨å®Œæˆ');

                    // å…ˆä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
                    this.saveMessage(userMessage);
                    console.log('ğŸ”¥ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å®Œæˆï¼Œå½“å‰å¯¹è¯ID:', appState.currentChatId);
                    console.log('ğŸ”¥ å¯¹è¯å†å²:', appState.chatHistory.find(c => c.id === appState.currentChatId));

                    // ç›´æ¥æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼Œä¸éœ€è¦é‡æ–°åŠ è½½æ•´ä¸ªå¯¹è¯
                    const chat = appState.chatHistory.find(c => c.id === appState.currentChatId);
                    if (chat && chat.messages.length > 0) {
                        console.log('ğŸ”¥ ç›´æ¥æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯');
                        // åªæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼Œä¸æ¸…ç©ºæ•´ä¸ªå®¹å™¨
                        this.addMessage(userMessage);
                    }

                    // ç§»é™¤äº†"æ–°å¯¹è¯å·²åˆ›å»º"çš„æ¶ˆæ¯æç¤º

                    // åœ¨æ¶ˆæ¯æ˜¾ç¤ºå®Œæˆåï¼Œæ¸…ç©ºè¾“å…¥æ¡†å¹¶ç¦ç”¨æŒ‰é’®
                    this.messageInput.value = '';
                    this.autoResize();
                    this.sendBtn.disabled = true;
                    this.sendBtn.classList.add('loading');

                    // æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒ
                    this.showThinkingIndicator();

                    // æ¨¡æ‹ŸAIå›å¤
                    setTimeout(() => {
                        this.removeThinkingIndicator();
                        this.generateAIResponse(text);
                    }, 1000 + Math.random() * 2000);
                } else {
                    // å·²æœ‰å¯¹è¯ï¼Œç›´æ¥æ·»åŠ æ¶ˆæ¯
                    this.addMessage(userMessage);
                    this.saveMessage(userMessage);

                    // æ¸…ç©ºè¾“å…¥æ¡†
                    this.messageInput.value = '';
                    this.autoResize();

                    // ç¦ç”¨å‘é€æŒ‰é’®
                    this.sendBtn.disabled = true;
                    this.sendBtn.classList.add('loading');

                    // æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒ
                    this.showThinkingIndicator();

                    // æ¨¡æ‹ŸAIå›å¤
                    setTimeout(() => {
                        this.removeThinkingIndicator();
                        this.generateAIResponse(text);
                    }, 1000 + Math.random() * 2000);
                }
            }

            generateChatTitle(firstMessage) {
                const title = firstMessage.length > 20 ?
                    firstMessage.substring(0, 20) + '...' :
                    firstMessage;
                return title;
            }

            showThinkingIndicator() {
                const thinkingMessage = {
                    id: 'thinking-' + Date.now(),
                    role: 'ai',
                    isThinking: true,
                    timestamp: new Date()
                };
                this.addMessage(thinkingMessage);
            }

            removeThinkingIndicator() {
                const thinkingMessage = this.messagesContainer.querySelector('[data-thinking="true"]');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
            }

            async generateAIResponse(userMessage) {
                // æ¨¡æ‹ŸAIå›å¤é€»è¾‘
                const response = await this.mockAIResponse(userMessage);

                const aiMessage = {
                    id: utils.generateId(),
                    role: 'ai',
                    content: response.content,
                    processNodes: response.processNodes,
                    thinking: response.thinking,
                    timestamp: new Date()
                };

                this.addMessage(aiMessage);
                this.saveMessage(aiMessage);

                // æ¢å¤å‘é€æŒ‰é’®
                this.sendBtn.disabled = false;
                this.sendBtn.classList.remove('loading');
            }

            async mockAIResponse(userMessage) {
                // ç®€åŒ–çš„AIå›å¤å†…å®¹
                const responses = [
                    {
                        content: `# äº§å“å‚æ•°æŸ¥è¯¢ç»“æœ

æ ¹æ®æ‚¨çš„æŸ¥è¯¢ï¼Œæˆ‘ä¸ºæ‚¨æ‰¾åˆ°äº†ç›¸å…³äº§å“ä¿¡æ¯ï¼š

## ç»Ÿä¸€é’›ç²’ç‹T10å…¨åˆæˆæŸ´æ²¹æœºæ²¹

ğŸ¯ **æ ¸å¿ƒå‚æ•°**ï¼š
- **APIç­‰çº§**ï¼šCK-4
- **SAEç²˜åº¦**ï¼š10W-40 / 5W-30
- **åŸºç¡€æ²¹ç±»å‹**ï¼šå…¨åˆæˆ
- **è¿åŠ¨ç²˜åº¦@100â„ƒ**ï¼š11.75 mmÂ²/s
- **é—ªç‚¹**ï¼š228â„ƒ
- **å€¾ç‚¹**ï¼š-45â„ƒ

âœ… **äº§å“ä¼˜åŠ¿**ï¼š
- æ´»å¡é¡¶éƒ¨é‡ç§¯ç¢³ä¸º0
- ç‡ƒæ²¹ç»æµæ€§è¾¾1.2%
- å®é™…é“è·¯æµ‹è¯•è¶…è¿‡12ä¸‡å…¬é‡Œ
- ä¼˜å¼‚çš„æŠ—ç£¨æŸæ€§èƒ½

ğŸ“¦ **åŒ…è£…è§„æ ¼**ï¼š
- 4Lè£… (4LÃ—4)
- 18Lè£… (18LÃ—1)
- 170kgè£…

å¦‚éœ€æ›´è¯¦ç»†çš„æŠ€æœ¯å‚æ•°ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“éœ€è¦å“ªé¡¹æ•°æ®ã€‚

---

## å‚è€ƒèµ„æ–™
- [çŸ¥è¯†å›¾è°±] ç»Ÿä¸€é’›ç²’ç‹T10äº§å“ä¿¡æ¯
- [æ–‡æ¡£] äº§å“èµ„æ–™æ–‡æ¡£`,
                        processNodes: [
                            { name: 'ç†è§£ç”¨æˆ·æŸ¥è¯¢', status: 'completed' },
                            { name: 'æ£€ç´¢äº§å“æ•°æ®åº“', status: 'completed' },
                            { name: 'æå–æŠ€æœ¯å‚æ•°', status: 'completed' },
                            { name: 'ç”Ÿæˆå›å¤å†…å®¹', status: 'completed' }
                        ],
                        thinking: appState.deepThinkingEnabled ?
                            'ç”¨æˆ·è¯¢é—®äº§å“å‚æ•°ï¼Œæˆ‘éœ€è¦æä¾›å®Œæ•´çš„æŠ€æœ¯è§„æ ¼ä¿¡æ¯ï¼ŒåŒ…æ‹¬APIç­‰çº§ã€ç²˜åº¦ã€åŸºç¡€æ²¹ç±»å‹ç­‰å…³é”®å‚æ•°ã€‚' : null
                    },
                    {
                        content: `# çŸ¿å±±è¡Œä¸šæ¶¦æ»‘è§£å†³æ–¹æ¡ˆ

ğŸ­ **è¡Œä¸šç‰¹ç‚¹åˆ†æ**ï¼š
éœ²å¤©çŸ¿ä¸šå·¥å†µç‰¹ç‚¹ï¼šæç«¯é«˜ä½æ¸©ã€ä½é€Ÿé‡è½½ã€é«˜ç²‰å°˜ç¯å¢ƒï¼Œå¯¹æ¶¦æ»‘æ²¹å“æå‡ºä¸¥å³»æŒ‘æˆ˜ã€‚

ğŸ”§ **æ¨èæ–¹æ¡ˆ**ï¼š

**é‡å‹è®¾å¤‡ï¼ˆ220å¨çº§çŸ¿å¡ï¼‰**ï¼š
- **æ¨èäº§å“**ï¼šç»Ÿä¸€é’›ç²’ç‹T10å…¨åˆæˆæŸ´æ²¹æœºæ²¹CK-4 10W-40
- **æ ¸å¿ƒä¼˜åŠ¿**ï¼šæ¢æ²¹å‘¨æœŸå»¶é•¿è‡³400å°æ—¶
- **ç»æµæ•ˆç›Š**ï¼šå¹´èŠ‚çº¦æˆæœ¬50ä¸‡å…ƒ

**ç”µé“²è®¾å¤‡**ï¼š
- **æ¨èäº§å“**ï¼šç»Ÿä¸€é½¿è½®æ²¹75W-90
- **æ ¸å¿ƒä¼˜åŠ¿**ï¼šæç«¯ä½æ¸©å·¥å†µç¨³å®šåº”ç”¨
- **æŠ€æœ¯ç‰¹ç‚¹**ï¼šä¼˜å¼‚çš„ä½æ¸©æµåŠ¨æ€§

**æŒ–æ˜è®¾å¤‡**ï¼š
- **æ¨èäº§å“**ï¼šç»Ÿä¸€æ¶²å‹æ²¹
- **æ ¸å¿ƒä¼˜åŠ¿**ï¼šæŠ—ç£¨æŸæ€§èƒ½ä¼˜å¼‚
- **é€‚ç”¨èŒƒå›´**ï¼šå„ç±»æ¶²å‹ç³»ç»Ÿ

âš¡ **ç»¼åˆä¼˜åŠ¿**ï¼š
- æ›¿æ¢è¿›å£å“ç‰Œï¼Œå¤§å¹…é™ä½ä½¿ç”¨æˆæœ¬
- æç«¯å·¥å†µä¸‹ç¨³å®šæ€§èƒ½ä¿éšœ
- ä¸“ä¸šæŠ€æœ¯æœåŠ¡æ”¯æŒ

ğŸ’¡ **å®æ–½å»ºè®®**ï¼š
å»ºè®®å»ºç«‹è®¾å¤‡ä¿å…»å°è´¦ï¼Œå®šæœŸç›‘æµ‹æ²¹å“çŠ¶æ€ï¼Œç¡®ä¿è®¾å¤‡ç¨³å®šè¿è¡Œã€‚

---

## å‚è€ƒèµ„æ–™
- [æ–‡æ¡£] çŸ¿å±±è¡Œä¸šè§£å†³æ–¹æ¡ˆ
- [çŸ¥è¯†å›¾è°±] å·¥ç¨‹è®¾å¤‡æ¶¦æ»‘æ–¹æ¡ˆ`,
                        processNodes: [
                            { name: 'è¯†åˆ«è¡Œä¸šåœºæ™¯', status: 'completed' },
                            { name: 'åˆ†æå·¥å†µç‰¹ç‚¹', status: 'completed' },
                            { name: 'åŒ¹é…äº§å“æ–¹æ¡ˆ', status: 'completed' },
                            { name: 'ç”Ÿæˆæ¨èæŠ¥å‘Š', status: 'completed' }
                        ],
                        thinking: appState.deepThinkingEnabled ?
                            'ç”¨æˆ·è¯¢é—®çŸ¿å±±è¡Œä¸šè§£å†³æ–¹æ¡ˆï¼Œæˆ‘éœ€è¦æ ¹æ®ä¸åŒè®¾å¤‡ç±»å‹æä¾›é’ˆå¯¹æ€§çš„æ¶¦æ»‘äº§å“æ¨èå’Œæ–¹æ¡ˆå»ºè®®ã€‚' : null
                    }
                ];

                return responses[Math.floor(Math.random() * responses.length)];
            }

            addMessage(message, skipAnimation = false) {
                console.log('ğŸ”¥ addMessage å¼€å§‹æ‰§è¡Œï¼Œæ¶ˆæ¯:', message, 'è·³è¿‡åŠ¨ç”»:', skipAnimation);
                const messageEl = this.createMessageElement(message);
                console.log('ğŸ”¥ æ¶ˆæ¯å…ƒç´ åˆ›å»ºå®Œæˆ:', messageEl);
                console.log('ğŸ”¥ messagesContainer:', this.messagesContainer);

                // æ£€æŸ¥æ¶ˆæ¯å®¹å™¨çš„å¯è§æ€§
                console.log('ğŸ”¥ messagesContainer display:', window.getComputedStyle(this.messagesContainer).display);
                console.log('ğŸ”¥ messagesContainer visibility:', window.getComputedStyle(this.messagesContainer).visibility);
                console.log('ğŸ”¥ messagesContainer opacity:', window.getComputedStyle(this.messagesContainer).opacity);
                console.log('ğŸ”¥ messagesContainer height:', window.getComputedStyle(this.messagesContainer).height);

                this.messagesContainer.appendChild(messageEl);
                console.log('ğŸ”¥ æ¶ˆæ¯å…ƒç´ å·²æ·»åŠ åˆ°å®¹å™¨');
                console.log('ğŸ”¥ å®¹å™¨å­å…ƒç´ æ•°é‡:', this.messagesContainer.children.length);

                this.scrollToBottom();

                // åªæœ‰åœ¨ä¸æ˜¯å†å²æ¶ˆæ¯æ¸²æŸ“æ—¶æ‰ä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
                if (message.role === 'ai' && !message.isThinking && !skipAnimation) {
                    console.log('ğŸ”¥ å¼€å§‹AIæ¶ˆæ¯æ‰“å­—æœºåŠ¨ç”»');
                    this.animateAIMessage(messageEl, message);
                } else if (message.role === 'ai' && skipAnimation) {
                    console.log('ğŸ”¥ è·³è¿‡AIæ¶ˆæ¯åŠ¨ç”»ï¼Œç›´æ¥æ˜¾ç¤ºå¯Œæ–‡æœ¬å†…å®¹');
                    // ç›´æ¥è®¾ç½®å†…å®¹ï¼Œä¸ä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
                    const responseTextEl = messageEl.querySelector(`#response-text-${message.id}`);
                    if (responseTextEl && message.content) {
                        const parsedContent = utils.parseMarkdown(message.content);
                        responseTextEl.innerHTML = parsedContent;
                        console.log('ğŸ”¥ ç›´æ¥è®¾ç½®AIæ¶ˆæ¯å¯Œæ–‡æœ¬å†…å®¹:', parsedContent);
                    }
                }
            }

            createMessageElement(message) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.role}`;
                messageEl.dataset.messageId = message.id;

                if (message.isThinking) {
                    messageEl.dataset.thinking = 'true';
                }

                const avatar = this.createAvatar(message.role);
                const content = this.createMessageContent(message);

                messageEl.appendChild(avatar);
                messageEl.appendChild(content);

                return messageEl;
            }

            createAvatar(role) {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';

                if (role === 'user') {
                    avatar.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    `;
                } else {
                    avatar.innerHTML = `
                        <img src="assets/images/logo.png" alt="AIäº§å“ä¸“å®¶">
                    `;
                }

                return avatar;
            }

            createMessageContent(message) {
                const content = document.createElement('div');
                content.className = 'message-content';

                if (message.isThinking) {
                    content.innerHTML = `
                        <div class="message-bubble">
                            <div class="thinking-indicator">
                                <span>å®‰å®‰æ­£åœ¨æ€è€ƒä¸­</span>
                                <div class="thinking-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (message.role === 'ai') {
                    content.innerHTML = this.createAIMessageHTML(message);
                } else {
                    content.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">${utils.escapeHtml(message.content)}</div>
                            <button class="copy-btn" onclick="chatManager.copyMessage('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }

                return content;
            }

            createAIMessageHTML(message) {
                let html = '<div class="ai-message">';

                // æµç¨‹èŠ‚ç‚¹
                if (message.processNodes && message.processNodes.length > 0) {
                    html += `
                        <div class="process-nodes" id="process-nodes-${message.id}">
                            <div class="process-nodes-header" onclick="chatManager.toggleProcessNodes('${message.id}')">
                                <h4>å¤„ç†æµç¨‹</h4>
                                <svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </div>
                            <div class="process-nodes-content">
                    `;

                    message.processNodes.forEach(node => {
                        const statusClass = node.status;
                        const statusIcon = node.status === 'completed' ? 'âœ“' :
                                         node.status === 'processing' ? 'âŸ³' :
                                         node.status === 'error' ? 'âœ•' : 'â—‹';

                        html += `
                            <div class="process-node">
                                <div class="node-status ${statusClass}">${statusIcon}</div>
                                <div class="node-name">${node.name}</div>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                }

                // æ€è€ƒè¿‡ç¨‹
                if (message.thinking && appState.deepThinkingEnabled) {
                    html += `
                        <div class="thinking-section" id="thinking-${message.id}">
                            <div class="thinking-header" onclick="chatManager.toggleThinking('${message.id}')">
                                <h4>æ€è€ƒè¿‡ç¨‹</h4>
                                <svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </div>
                            <div class="thinking-content">
                                <div class="thinking-text">${message.thinking}</div>
                            </div>
                        </div>
                    `;
                }

                // å›å¤å†…å®¹
                html += `
                    <div class="message-body">
                        <div class="response-text" id="response-text-${message.id}"></div>
                        <div class="message-actions">
                            <button class="action-btn" onclick="chatManager.copyMessage('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                                å¤åˆ¶æ¶ˆæ¯
                            </button>
                            <button class="action-btn" onclick="chatManager.exportHTML('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                ç”ŸæˆHTML
                            </button>
                            <button class="action-btn" onclick="chatManager.exportPDF('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L10,15L13,15L17,10"/>
                                </svg>
                                å¯¼å‡ºPDF
                            </button>
                        </div>
                    </div>
                `;

                html += '</div>';
                return html;
            }

            animateAIMessage(messageEl, message) {
                const responseTextEl = messageEl.querySelector(`#response-text-${message.id}`);
                if (responseTextEl && message.content) {
                    console.log('ğŸ”¥ å¼€å§‹å¯Œæ–‡æœ¬æ‰“å­—æœºæ•ˆæœï¼ŒåŸå§‹Markdown:', message.content);
                    this.currentTypingEffect = new RichTextTypingEffect(responseTextEl, message.content, 10);
                    this.currentTypingEffect.start();
                }
            }

            toggleProcessNodes(messageId) {
                const nodesEl = document.getElementById(`process-nodes-${messageId}`);
                if (nodesEl) {
                    nodesEl.classList.toggle('expanded');
                }
            }

            toggleThinking(messageId) {
                const thinkingEl = document.getElementById(`thinking-${messageId}`);
                if (thinkingEl) {
                    thinkingEl.classList.toggle('expanded');
                }
            }

            copyMessage(messageId) {
                const message = appState.chatHistory
                    .find(chat => chat.messages.some(msg => msg.id === messageId))
                    ?.messages.find(msg => msg.id === messageId);

                if (message) {
                    utils.copyToClipboard(message.content);
                }
            }

            exportHTML(messageId) {
                const message = appState.chatHistory
                    .find(chat => chat.messages.some(msg => msg.id === messageId))
                    ?.messages.find(msg => msg.id === messageId);

                if (message) {
                    this.downloadHTML(message.content, `ai-response-${messageId}.html`);
                }
            }

            downloadHTML(content, filename) {
                const html = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIäº§å“ä¸“å®¶å›å¤</title>
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #4d6bfe; border-bottom: 2px solid #4d6bfe; padding-bottom: 10px; }
        h2 { color: #1f2937; margin-top: 30px; }
        h3 { color: #1f2937; }
        ul, li { margin: 10px 0; }
        strong { color: #4d6bfe; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
        .section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }
    </style>
</head>
<body>
    <div style="text-align: center; margin-bottom: 30px;">
        <h1>AIäº§å“ä¸“å®¶å›å¤</h1>
        <p style="color: #666;">ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
    </div>
    <div class="content">
        ${content.replace(/#{1,6}\s+/g, '<h2>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
    </div>
    <hr style="margin: 40px 0;">
    <p style="text-align: center; color: #999; font-size: 14px;">
        ç”±AIäº§å“ä¸“å®¶å®‰å®‰ç”Ÿæˆ | ç»Ÿä¸€æ¶¦æ»‘æ²¹å…¬å¸
    </p>
</body>
</html>`;

                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                utils.showToast('HTMLæ–‡ä»¶å·²ç”Ÿæˆ', 'success');
            }

            exportPDF(messageId) {
                const message = appState.chatHistory
                    .find(chat => chat.messages.some(msg => msg.id === messageId))
                    ?.messages.find(msg => msg.id === messageId);

                if (message) {
                    this.printToPDF(message.content, messageId);
                }
            }

            printToPDF(content, messageId) {
                try {
                    // åŠ¨æ€åŠ è½½jsPDFåº“
                    if (typeof window.jspdf === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
                        script.onload = () => this.generatePDF(content, messageId);
                        script.onerror = () => {
                            console.error('jsPDFåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                            this.fallbackPDF(content);
                        };
                        document.head.appendChild(script);
                    } else {
                        this.generatePDF(content, messageId);
                    }
                } catch (error) {
                    console.error('ç”ŸæˆPDFå¤±è´¥:', error);
                    utils.showToast('ç”ŸæˆPDFå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }

            generatePDF(content, messageId) {
                try {
                    const { jsPDF } = window.jspdf;

                    // åˆ›å»ºPDFæ–‡æ¡£ï¼Œä½¿ç”¨A4çº¸å¼ 
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // ä½¿ç”¨è‹±æ–‡æ¨¡æ¿æ¶ˆæ¯ï¼ˆé¿å…ä¸­æ–‡ç¼–ç é—®é¢˜ï¼‰
                    const templateContent = `# AI Product Expert Recommendation

## Product Analysis
Based on your requirements, I recommend the following lubrication solutions:

### **Premium Engine Oil Series**
- **Product Code**: UEO-2025-XP
- **Viscosity**: 5W-30
- **Specifications**: API SP, ILSAC GF-6
- **Benefits**:
  - Superior engine protection
  - Enhanced fuel economy
  - Extended drain intervals
  - Excellent thermal stability

### **Industrial Gear Oil**
- **Product Code**: IGO-2025-HD
- **Viscosity Range**: ISO VG 220-460
- **Applications**:
  - Heavy-duty gearboxes
  - Industrial machinery
  - Mining equipment
  - Wind turbines

## Technical Specifications

### Performance Characteristics
| Parameter | Value | Unit |
|-----------|-------|------|
| Kinematic Viscosity @40Â°C | 89.2 | mmÂ²/s |
| Kinematic Viscosity @100Â°C | 14.1 | mmÂ²/s |
| Viscosity Index | 171 | - |
| Flash Point | 210 | Â°C |
| Pour Point | -42 | Â°C |

### Compatibility
- Compatible with most synthetic and mineral oils
- Suitable for gasoline and diesel engines
- Meets OEM requirements for major manufacturers

## Usage Recommendations

### Application Instructions
1. **Preparation**: Ensure equipment is clean and dry
2. **Application**: Follow manufacturer's recommended fill levels
3. **Monitoring**: Check oil quality periodically
4. **Replacement**: Change oil according to service schedule

### Storage Guidelines
- Store in original containers
- Keep away from direct sunlight
- Temperature range: -20Â°C to 50Â°C
- Shelf life: 5 years from production date

## Quality Assurance

Our products undergo rigorous testing:
- Laboratory analysis
- Field performance validation
- Quality certification
- Environmental compliance testing

## Contact Information
For technical support and inquiries:
- **Phone**: +86-400-888-9999
- **Email**: expert@unified-lubricants.com
- **Website**: www.unified-lubricants.com

---
*This recommendation is generated by AI Product Expert System based on your specific requirements and industry best practices.*`;

                    // PDFé¡µé¢è®¾ç½®
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 20;
                    const lineHeight = 6;
                    const maxLineWidth = pageWidth - 2 * margin;
                    let currentY = margin;

                    // æ·»åŠ æ ‡é¢˜
                    pdf.setFontSize(20);
                    pdf.setTextColor(77, 107, 254);
                    pdf.text('AI Product Expert Report', margin, currentY);
                    currentY += 15;

                    // æ·»åŠ æ—¶é—´æˆ³
                    pdf.setFontSize(10);
                    pdf.setTextColor(153, 153, 153);
                    const timestamp = new Date().toLocaleString('en-US');
                    pdf.text(`Generated: ${timestamp}`, margin, currentY);
                    currentY += 10;

                    // æ·»åŠ åˆ†å‰²çº¿
                    pdf.setDrawColor(221, 221, 221);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 10;

                    // å¤„ç†æ¨¡æ¿å†…å®¹ï¼Œè‡ªåŠ¨æ¢è¡Œ
                    pdf.setFontSize(12);
                    pdf.setTextColor(51, 51, 51);

                    const lines = pdf.splitTextToSize(templateContent, maxLineWidth);

                    lines.forEach(line => {
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µé¢
                        if (currentY + lineHeight > pageHeight - margin) {
                            pdf.addPage();
                            currentY = margin;
                        }

                        pdf.text(line, margin, currentY);
                        currentY += lineHeight;
                    });

                    // æ·»åŠ é¡µè„š
                    const footerY = pageHeight - 15;
                    pdf.setFontSize(10);
                    pdf.setTextColor(153, 153, 153);
                    pdf.text('Generated by AI Product Expert | Unified Lubricants Co., Ltd.', margin, footerY);

                    // ç”Ÿæˆæ–‡ä»¶å
                    const timestamp2 = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    const filename = `AI_Product_Expert_Report_${timestamp2}.pdf`;

                    // ä¿å­˜PDF
                    pdf.save(filename);

                    utils.showToast('PDF report successfully generated and downloaded', 'success');

                } catch (error) {
                    console.error('PDF generation failed:', error);
                    utils.showToast('PDF generation failed, trying fallback...', 'warning');
                    this.fallbackPDF(content);
                }
            }

            fallbackPDF(content) {
                try {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç”Ÿæˆçº¯æ–‡æœ¬æ–‡ä»¶
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = utils.parseMarkdown(content);
                    const textContent = tempDiv.textContent || content;

                    const fileContent = `AI Product Expert Reply
========================

Generated: ${new Date().toLocaleString('zh-CN')}

${textContent}

---
Generated by AI Product Expert An An | Unified Lubricants Co., Ltd.
`;

                    const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    a.download = `AI_Reply_${timestamp}.txt`;

                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    utils.showToast('å·²ç”Ÿæˆæ–‡æœ¬æ–‡ä»¶ï¼Œè¯·å¤åˆ¶å†…å®¹åˆ°Wordä¸­å¦å­˜ä¸ºPDF', 'success');

                } catch (error) {
                    console.error('å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†:', error);
                    utils.showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }

            saveMessage(message) {
                const currentChat = appState.chatHistory.find(chat => chat.id === appState.currentChatId);
                if (currentChat) {
                    currentChat.messages.push(message);
                    appState.saveState();
                }
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        }

        // æ¬¢è¿é¡µé¢ç®¡ç†
        class WelcomeManager {
            constructor() {
                this.welcomeText = document.getElementById('welcome-text');
                this.welcomeMessages = [
                    `æˆ‘æ˜¯å®‰å®‰ï¼Œæœ‰ä»€ä¹ˆæ¶¦æ»‘æ²¹ã€æ¶²å†·ç›¸å…³é—®é¢˜æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å—ï¼Ÿ`
                ];
                this.currentMessageIndex = 0;
                this.typingEffect = null;
                this.init();
            }

            init() {
                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    const welcomeScreen = document.getElementById('welcome-screen');
                    const inputArea = document.querySelector('.input-area');

                    console.log('ğŸ”¥ WelcomeManager å»¶è¿Ÿinit å¼€å§‹');
                    console.log('ğŸ”¥ welcomeScreen:', welcomeScreen);
                    console.log('ğŸ”¥ inputArea:', inputArea);

                    if (welcomeScreen) {
                        welcomeScreen.classList.add('active');
                        console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢å·²æ·»åŠ activeç±»');
                    }

                    // å†æ¬¡å»¶è¿Ÿè®¾ç½®è¾“å…¥æ¡†ä½ç½®ï¼Œç¡®ä¿æ ·å¼å®Œå…¨ç”Ÿæ•ˆ
                    setTimeout(() => {
                        if (inputArea) {
                            console.log('ğŸ”¥ WelcomeManager å¼€å§‹è®¾ç½®è¾“å…¥æ¡†ä½ç½®');

                            // å…ˆå¼ºåˆ¶æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ ·å¼
                            inputArea.style.cssText = '';

                            // é‡æ–°è®¾ç½®æˆ‘ä»¬æƒ³è¦çš„æ ·å¼
                            inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ä¸‹è°ƒ50pxï¼Œè°ƒæ•´ä¸º-250px */
                            inputArea.style.setProperty('background-color', 'transparent', 'important');
                            inputArea.style.setProperty('padding-top', '0', 'important');
                            inputArea.style.setProperty('padding-bottom', '0', 'important');
                            inputArea.style.setProperty('margin-bottom', '0', 'important');

                            console.log('ğŸ”¥ WelcomeManager è¾“å…¥æ¡†ä½ç½®è®¾ç½®å®Œæˆ');
                            console.log('ğŸ”¥ è®¾ç½®åçš„æ ·å¼:', inputArea.style.cssText);

                            // é¢å¤–æ£€æŸ¥ï¼šå†æ¬¡ç¡®è®¤æ ·å¼æ˜¯å¦è®¾ç½®æˆåŠŸ
                            setTimeout(() => {
                                const computedStyle = window.getComputedStyle(inputArea);
                                console.log('ğŸ”¥ è®¡ç®—åçš„marginTop:', computedStyle.marginTop);
                                console.log('ğŸ”¥ è®¡ç®—åçš„backgroundColor:', computedStyle.backgroundColor);
                            }, 50);
                        } else {
                            console.error('ğŸ”¥ æ‰¾ä¸åˆ°inputAreaå…ƒç´ ï¼');
                        }
                    }, 200);
                }, 300); // å¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿DOMå®Œå…¨åŠ è½½

                this.startWelcomeAnimation();
                this.bindTaskCards();
            }

            startWelcomeAnimation() {
                this.showWelcomeMessage();
            }

            showWelcomeMessage() {
                const message = this.welcomeMessages[this.currentMessageIndex];
                this.typingEffect = new TypingEffect(this.welcomeText, message, 120);
                this.typingEffect.onComplete = () => {
                    setTimeout(() => {
                        this.currentMessageIndex = (this.currentMessageIndex + 1) % this.welcomeMessages.length;
                        this.showWelcomeMessage();
                    }, 5000);
                };
                this.typingEffect.start();
            }

            bindTaskCards() {
                const taskCards = document.querySelectorAll('.task-card');
                taskCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const taskType = card.dataset.task;
                        this.handleTaskCardClick(taskType);
                    });
                });
            }

            handleTaskCardClick(taskType) {
                switch (taskType) {
                    case 'product-query':
                        modalManager.show(this.createProductQueryModal());
                        break;
                    case 'competitor-comparison':
                        modalManager.show(this.createCompetitorComparisonModal());
                        break;
                    case 'scenario-solution':
                        modalManager.show(this.createScenarioSolutionModal());
                        break;
                }
            }

            createProductQueryModal() {
                return `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">äº§å“å‚æ•°é€ŸæŸ¥</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">äº§å“åç§°/ç‰©æ–™å·/ç‰©æ–™æè¿°</label>
                                <input type="text" class="form-input" id="product-name" placeholder="ä¾‹å¦‚ï¼šç»Ÿä¸€é’›ç²’ç‹T10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å‚æ•°åç§°</label>
                                <select class="form-select" id="parameter-type">
                                    <option value="all">å…¨éƒ¨å‚æ•°</option>
                                    <option value="viscosity">è¿åŠ¨ç²˜åº¦</option>
                                    <option value="flash-point">é—ªç‚¹</option>
                                    <option value="pour-point">å€¾ç‚¹</option>
                                    <option value="api-level">APIç­‰çº§</option>
                                </select>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="deep-thinking-query">
                                <label for="deep-thinking-query">å¼€å¯æ·±åº¦æ€è€ƒ</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="welcomeManager.sendProductQuery()">å‘é€</button>
                        </div>
                    </div>
                `;
            }

            createCompetitorComparisonModal() {
                return `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">ç”Ÿæˆç«å“å¯¹æ¯”è¡¨</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">äº§å“åç§°</label>
                                <input type="text" class="form-input" id="product-1" placeholder="ä¾‹å¦‚ï¼šç»Ÿä¸€é’›ç²’ç‹T10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¯¹æ¯”äº§å“åç§°</label>
                                <input type="text" class="form-input" id="product-2" placeholder="ä¾‹å¦‚ï¼šå£³ç‰ŒåŠ²éœ¸K10">
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="deep-thinking-comparison">
                                <label for="deep-thinking-comparison">å¼€å¯æ·±åº¦æ€è€ƒ</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="welcomeManager.sendComparison()">å‘é€</button>
                        </div>
                    </div>
                `;
            }

            createScenarioSolutionModal() {
                return `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">åˆ›å»ºåœºæ™¯æ–¹æ¡ˆ</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">è¡Œä¸š/åœºæ™¯</label>
                                <select class="form-select" id="industry-type">
                                    <option value="">è¯·é€‰æ‹©è¡Œä¸š</option>
                                    <option value="mining">çŸ¿å±±</option>
                                    <option value="logistics">ç‰©æµ</option>
                                    <option value="construction">å»ºç­‘</option>
                                    <option value="manufacturing">åˆ¶é€ </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">è®¾å¤‡/å‹å·/æ¶¦æ»‘éƒ¨ä½åŠå·¥å†µ/æ’æ”¾ä¿¡æ¯</label>
                                <textarea class="form-textarea" id="equipment-info" placeholder="ä¾‹å¦‚ï¼šå°æ¾PC850æŒ–æ˜æœºï¼Œé‡è½½å·¥å†µï¼Œå›½å…­æ’æ”¾ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœŸæœ›è¾¾æˆçš„ç›®æ ‡</label>
                                <textarea class="form-textarea" id="expected-goals" placeholder="ä¾‹å¦‚ï¼šå»¶é•¿æ¢æ²¹å‘¨æœŸï¼Œé™ä½ç»´æŠ¤æˆæœ¬ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></textarea>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="deep-thinking-solution" checked>
                                <label for="deep-thinking-solution">å¼€å¯æ·±åº¦æ€è€ƒ</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="welcomeManager.sendSolution()">å‘é€</button>
                        </div>
                    </div>
                `;
            }

            sendProductQuery() {
                const productName = document.getElementById('product-name').value;
                const parameterType = document.getElementById('parameter-type').value;
                const deepThinking = document.getElementById('deep-thinking-query').checked;

                if (!productName.trim()) {
                    utils.showToast('è¯·è¾“å…¥äº§å“åç§°', 'error');
                    return;
                }

                const message = `æŸ¥è¯¢${productName}çš„${parameterType === 'all' ? 'å…¨éƒ¨å‚æ•°' : parameterType}`;

                appState.deepThinkingEnabled = deepThinking;
                chatManager.messageInput.value = message;
                modalManager.close();
                chatManager.sendMessage();
            }

            sendComparison() {
                const product1 = document.getElementById('product-1').value;
                const product2 = document.getElementById('product-2').value;
                const deepThinking = document.getElementById('deep-thinking-comparison').checked;

                if (!product1.trim() || !product2.trim()) {
                    utils.showToast('è¯·è¾“å…¥è¦å¯¹æ¯”çš„äº§å“åç§°', 'error');
                    return;
                }

                const message = `å¯¹æ¯”${product1}å’Œ${product2}çš„æ€§èƒ½å‚æ•°å’Œç‰¹ç‚¹`;

                appState.deepThinkingEnabled = deepThinking;
                chatManager.messageInput.value = message;
                modalManager.close();
                chatManager.sendMessage();
            }

            sendSolution() {
                const industryType = document.getElementById('industry-type').value;
                const equipmentInfo = document.getElementById('equipment-info').value;
                const expectedGoals = document.getElementById('expected-goals').value;
                const deepThinking = document.getElementById('deep-thinking-solution').checked;

                if (!industryType || !equipmentInfo.trim()) {
                    utils.showToast('è¯·å¡«å†™å®Œæ•´çš„è¡Œä¸šå’Œè®¾å¤‡ä¿¡æ¯', 'error');
                    return;
                }

                const message = `ä¸º${industryType}è¡Œä¸šçš„${equipmentInfo}æä¾›æ¶¦æ»‘æ–¹æ¡ˆï¼Œç›®æ ‡ï¼š${expectedGoals || 'ä¼˜åŒ–æ¶¦æ»‘æ•ˆæœ'}`;

                appState.deepThinkingEnabled = deepThinking;
                chatManager.messageInput.value = message;
                modalManager.close();
                chatManager.sendMessage();
            }
        }

        // ä¾§è¾¹æ ç®¡ç†
        class SidebarManager {
            constructor() {
                this.sidebar = document.getElementById('sidebar');
                this.historyList = document.getElementById('history-list');
                this.init();
            }

            init() {
                this.bindToggle();
                this.bindTopNewChat();
                this.bindNewChat();
                this.bindUserMenu();
                this.bindBrandClick();
                this.loadChatHistory();
            }

            bindToggle() {
                const toggleBtn = document.getElementById('sidebar-toggle');
                toggleBtn.addEventListener('click', () => {
                    this.toggle();
                });
            }

            bindTopNewChat() {
                const combinedActionBtn = document.getElementById('combined-action-btn');
                console.log('ğŸ”¥ bindTopNewChat - æ‰¾åˆ°ç»„åˆæŒ‰é’®:', combinedActionBtn);

                combinedActionBtn.addEventListener('click', (e) => {
                    console.log('ğŸ”¥ ç»„åˆæŒ‰é’®è¢«ç‚¹å‡»');
                    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å“ªä¸ªéƒ¨åˆ†
                    const expandIcon = e.target.closest('.expand-icon');
                    const newChatIcon = e.target.closest('.new-chat-icon');

                    console.log('ğŸ”¥ expandIcon:', expandIcon);
                    console.log('ğŸ”¥ newChatIcon:', newChatIcon);
                    console.log('ğŸ”¥ e.target:', e.target);

                    if (expandIcon) {
                        // ç‚¹å‡»å±•å¼€å›¾æ ‡ - å±•å¼€ä¾§è¾¹æ 
                        console.log('ğŸ”¥ ç‚¹å‡»äº†å±•å¼€å›¾æ ‡');
                        this.expand();
                    } else if (newChatIcon) {
                        // ç‚¹å‡»æ–°å»ºå¯¹è¯å›¾æ ‡ - åˆ›å»ºæ–°å¯¹è¯
                        console.log('ğŸ”¥ ç‚¹å‡»äº†æ–°å»ºå¯¹è¯å›¾æ ‡');
                        this.createNewChat();
                    } else if (e.target === combinedActionBtn) {
                        // ç‚¹å‡»æŒ‰é’®å…¶ä»–åŒºåŸŸ - é»˜è®¤ä¸ºæ–°å»ºå¯¹è¯
                        console.log('ğŸ”¥ ç‚¹å‡»äº†æŒ‰é’®å…¶ä»–åŒºåŸŸ');
                        this.createNewChat();
                    }
                });
            }

            expand() {
                appState.sidebarCollapsed = false;
                this.sidebar.classList.remove('collapsed');

                // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                appState.save();
            }

            toggle() {
                appState.sidebarCollapsed = !appState.sidebarCollapsed;
                this.sidebar.classList.toggle('collapsed');

                // åŒæ—¶åˆ‡æ¢ä¸»é¡µé¢çš„å±…ä¸­æ ·å¼
                const mainPage = document.getElementById('main-page');
                if (appState.sidebarCollapsed) {
                    mainPage.classList.add('sidebar-hidden');
                } else {
                    mainPage.classList.remove('sidebar-hidden');
                }

                // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                appState.save();
            }

            bindNewChat() {
                const newChatBtn = document.getElementById('new-chat-btn');
                const newChatBtnMini = document.getElementById('new-chat-btn-mini');

                newChatBtn.addEventListener('click', () => {
                    this.createNewChat();
                });

                newChatBtnMini.addEventListener('click', () => {
                    this.createNewChat();
                });
            }

            createNewChat() {
                // è„±ç¦»å½“å‰å¯¹è¯ï¼Œå›åˆ°ä¸»ç•Œé¢
                console.log('ğŸ”¥ createNewChat - é‡ç½®currentChatIdä¹‹å‰:', appState.currentChatId);
                appState.currentChatId = null;
                console.log('ğŸ”¥ createNewChat - é‡ç½®currentChatIdä¹‹å:', appState.currentChatId);
                this.showWelcomeScreen();
                this.clearMessages();

                // æ¸…é™¤å†å²åˆ—è¡¨ä¸­çš„é€‰ä¸­çŠ¶æ€
                this.clearHistorySelection();

                // ç§»é™¤äº†"å·²å›åˆ°ä¸»ç•Œé¢"çš„æ¶ˆæ¯æç¤º
            }

            clearHistorySelection() {
                // æ¸…é™¤å†å²åˆ—è¡¨ä¸­æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                const historyItems = this.historyList.querySelectorAll('.history-item');
                historyItems.forEach(item => {
                    item.classList.remove('active');
                });
            }

            deleteChat(chatId) {
                console.log('ğŸ”¥ åˆ é™¤å¯¹è¯:', chatId);

                // ç¡®è®¤åˆ é™¤
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                    // ä»å†å²è®°å½•ä¸­åˆ é™¤
                    const chatIndex = appState.chatHistory.findIndex(c => c.id === chatId);
                    if (chatIndex !== -1) {
                        appState.chatHistory.splice(chatIndex, 1);
                        console.log('ğŸ”¥ å¯¹è¯å·²åˆ é™¤ï¼Œå‰©ä½™å¯¹è¯æ•°é‡:', appState.chatHistory.length);

                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œå›åˆ°ä¸»ç•Œé¢
                        if (appState.currentChatId === chatId) {
                            console.log('ğŸ”¥ åˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œå›åˆ°ä¸»ç•Œé¢');
                            appState.currentChatId = null;
                            this.showWelcomeScreen();
                            this.clearMessages();
                        }

                        // ä¿å­˜çŠ¶æ€
                        appState.saveState();

                        // é‡æ–°æ¸²æŸ“å†å²åˆ—è¡¨
                        this.renderChatHistory();

                        utils.showToast('å¯¹è¯å·²åˆ é™¤', 'success');
                    } else {
                        console.error('ğŸ”¥ æœªæ‰¾åˆ°è¦åˆ é™¤çš„å¯¹è¯:', chatId);
                        utils.showToast('åˆ é™¤å¤±è´¥ï¼Œå¯¹è¯ä¸å­˜åœ¨', 'error');
                    }
                } else {
                    console.log('ğŸ”¥ ç”¨æˆ·å–æ¶ˆåˆ é™¤');
                }
            }

            bindBrandClick() {
                // ç­‰å¾…DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    // ä¸ºæ‰€æœ‰brand-infoå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const brandInfos = document.querySelectorAll('.brand-info');
                    console.log('ğŸ”¥ bindBrandClick - æ‰¾åˆ°brand-infoå…ƒç´ æ•°é‡:', brandInfos.length);
                    console.log('ğŸ”¥ bindBrandClick - DOMçŠ¶æ€:', document.readyState);

                    brandInfos.forEach((brandInfo, index) => {
                        console.log(`ğŸ”¥ brand-info ${index}:`, brandInfo);

                        brandInfo.addEventListener('click', (e) => {
                            console.log('ğŸ”¥ brand-infoè¢«ç‚¹å‡»:', index);
                            console.log('ğŸ”¥ ç‚¹å‡»ç›®æ ‡:', e.target);

                            // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯å…¶ä»–æŒ‰é’®æˆ–å¯äº¤äº’å…ƒç´ 
                            const isButton = e.target.closest('button');
                            const isUserMenu = e.target.closest('.user-menu');

                            if (!isButton && !isUserMenu) {
                                console.log('ğŸ”¥ è§¦å‘æ–°å»ºå¯¹è¯');
                                this.createNewChat();
                            } else {
                                console.log('ğŸ”¥ ç‚¹å‡»äº†æŒ‰é’®æˆ–ç”¨æˆ·èœå•ï¼Œä¸è§¦å‘æ–°å»ºå¯¹è¯');
                            }
                        });

                        // ä¸ºbrand-infoå†…çš„æ‰€æœ‰å­å…ƒç´ æ·»åŠ æ ·å¼
                        const brandElements = brandInfo.querySelectorAll('*');
                        brandInfo.style.cursor = 'pointer';
                        brandInfo.title = 'ç‚¹å‡»æ–°å»ºå¯¹è¯';

                        brandElements.forEach(el => {
                            el.style.cursor = 'pointer';
                            el.title = 'ç‚¹å‡»æ–°å»ºå¯¹è¯';
                        });
                    });
                }, 100); // å»¶è¿Ÿ100msç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
            }

            bindUserMenu() {
                const userBtn = document.getElementById('user-menu-btn');
                const userDropdown = document.getElementById('user-dropdown');

                userBtn.addEventListener('click', () => {
                    userDropdown.classList.toggle('show');
                });

                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', (e) => {
                    if (!userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('show');
                    }
                });

                // åé¦ˆä¸å¸®åŠ©
                document.getElementById('feedback-btn').addEventListener('click', () => {
                    userDropdown.classList.remove('show');
                    this.showFeedbackModal();
                });

                // é€€å‡ºç™»å½•
                document.getElementById('logout-btn').addEventListener('click', () => {
                    userDropdown.classList.remove('show');
                    this.logout();
                });
            }

            showFeedbackModal() {
                modalManager.show(`
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">åé¦ˆä¸å¸®åŠ©</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">åé¦ˆç±»å‹</label>
                                <select class="form-select">
                                    <option value="bug">é—®é¢˜åé¦ˆ</option>
                                    <option value="suggestion">åŠŸèƒ½å»ºè®®</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">é—®é¢˜æè¿°</label>
                                <textarea class="form-textarea" rows="4" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®... Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">è”ç³»æ–¹å¼ï¼ˆé€‰å¡«ï¼‰</label>
                                <input type="text" class="form-input" placeholder="é‚®ç®±æˆ–ç”µè¯">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="sidebarManager.submitFeedback()">æäº¤</button>
                        </div>
                    </div>
                `);
            }

            submitFeedback() {
                utils.showToast('åé¦ˆå·²æäº¤ï¼Œæ„Ÿè°¢æ‚¨çš„å®è´µæ„è§ï¼', 'success');
                modalManager.close();
            }

            logout() {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    appState.clearState();
                    appManager.showLoginPage();
                    utils.showToast('å·²é€€å‡ºç™»å½•', 'info');
                }
            }

            loadChatHistory() {
                // åˆå§‹åŒ–ä¾§è¾¹æ çŠ¶æ€
                this.initializeSidebarState();
                this.renderChatHistory();
            }

            initializeSidebarState() {
                if (appState.sidebarCollapsed) {
                    this.sidebar.classList.add('collapsed');
                    // åŒæ—¶è®¾ç½®ä¸»é¡µé¢çš„å±…ä¸­æ ·å¼
                    const mainPage = document.getElementById('main-page');
                    mainPage.classList.add('sidebar-hidden');
                }
            }

            renderChatHistory() {
                this.historyList.innerHTML = '';

                if (appState.chatHistory.length === 0) {
                    this.historyList.innerHTML = '<div class="history-item">æš‚æ— å†å²å¯¹è¯</div>';
                    return;
                }

                appState.chatHistory.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'history-item';
                    if (chat.id === appState.currentChatId) {
                        chatItem.classList.add('active');
                    }

                    chatItem.innerHTML = `
                        <div class="chat-content">
                            <div class="chat-title">${chat.title}</div>
                            <div class="chat-time">${utils.formatTime(chat.createdAt)}</div>
                        </div>
                        <div class="chat-actions">
                            <button class="delete-btn" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"/>
                                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/>
                                </svg>
                            </button>
                        </div>
                    `;

                    // ç‚¹å‡»å¯¹è¯å†…å®¹åŠ è½½å¯¹è¯
                    const chatContent = chatItem.querySelector('.chat-content');
                    chatContent.addEventListener('click', () => {
                        this.loadChat(chat.id);
                    });

                    // ç‚¹å‡»åˆ é™¤æŒ‰é’®åˆ é™¤å¯¹è¯
                    const deleteBtn = chatItem.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                        this.deleteChat(chat.id);
                    });

                    this.historyList.appendChild(chatItem);
                });
            }

            loadChat(chatId) {
                const chat = appState.chatHistory.find(c => c.id === chatId);
                if (!chat) return;

                console.log('ğŸ”¥ loadChat - å¼€å§‹åŠ è½½å¯¹è¯:', chatId);
                console.log('ğŸ”¥ loadChat - å¯¹è¯å†…å®¹:', chat);

                appState.currentChatId = chatId;
                this.renderChatHistory();
                this.hideWelcomeScreen();

                console.log('ğŸ”¥ loadChat - å¼€å§‹æ¸²æŸ“æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ•°é‡:', chat.messages.length);
                this.renderMessages(chat.messages);
                console.log('ğŸ”¥ loadChat - æ¶ˆæ¯æ¸²æŸ“å®Œæˆ');
            }

            renderMessages(messages) {
                chatManager.messagesContainer.innerHTML = '';
                console.log('ğŸ”¥ renderMessages - æ¸²æŸ“å†å²æ¶ˆæ¯ï¼Œæ•°é‡:', messages.length);
                messages.forEach(message => {
                    console.log('ğŸ”¥ renderMessages - æ¸²æŸ“å†å²æ¶ˆæ¯ï¼Œè·³è¿‡åŠ¨ç”»:', message);
                    chatManager.addMessage(message, true); // å†å²æ¶ˆæ¯è·³è¿‡åŠ¨ç”»
                });
            }

            hideWelcomeScreen() {
                console.log('ğŸ”¥ hideWelcomeScreen å¼€å§‹æ‰§è¡Œ');
                const welcomeScreen = document.getElementById('welcome-screen');
                const chatContainer = document.getElementById('chat-container');
                const inputArea = document.querySelector('.input-area');

                console.log('ğŸ”¥ welcomeScreen:', welcomeScreen);
                console.log('ğŸ”¥ chatContainer:', chatContainer);

                if (welcomeScreen) {
                    console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢å½“å‰display:', window.getComputedStyle(welcomeScreen).display);
                    welcomeScreen.style.display = 'none';
                    welcomeScreen.classList.remove('active'); // ç§»é™¤activeç±»
                    console.log('ğŸ”¥ éšè—æ¬¢è¿ç•Œé¢');
                }
                if (chatContainer) {
                    console.log('ğŸ”¥ èŠå¤©å®¹å™¨å½“å‰display:', window.getComputedStyle(chatContainer).display);
                    chatContainer.style.display = 'flex';
                    console.log('ğŸ”¥ æ˜¾ç¤ºèŠå¤©å®¹å™¨');
                }

                // å¼ºåˆ¶æ¢å¤è¾“å…¥æ¡†æ ·å¼
                if (inputArea) {
                    console.log('ğŸ”¥ æ¢å¤è¾“å…¥æ¡†æ ·å¼');
                    inputArea.style.setProperty('background-color', '', 'important');
                    inputArea.style.setProperty('margin-top', '', 'important');
                    inputArea.style.setProperty('padding-top', '', 'important');
                    inputArea.style.setProperty('margin-bottom', '', 'important');
                    inputArea.style.setProperty('position', '', 'important');
                    inputArea.style.setProperty('z-index', '', 'important');
                    console.log('ğŸ”¥ è¾“å…¥æ¡†æ ·å¼å·²æ¢å¤');
                }

                // æ£€æŸ¥èŠå¤©å®¹å™¨çš„çˆ¶å…ƒç´ 
                const mainContent = document.querySelector('.main-content');
                console.log('ğŸ”¥ main-content:', mainContent);
                if (mainContent) {
                    console.log('ğŸ”¥ main-content display:', window.getComputedStyle(mainContent).display);
                }
            }

            showWelcomeScreen() {
                const welcomeScreen = document.getElementById('welcome-screen');
                const chatContainer = document.getElementById('chat-container');

                console.log('ğŸ”¥ showWelcomeScreen å¼€å§‹æ‰§è¡Œ');
                console.log('ğŸ”¥ welcomeScreen:', welcomeScreen);

                if (welcomeScreen) {
                    welcomeScreen.style.display = 'flex';
                    welcomeScreen.classList.add('active'); // æ·»åŠ activeç±»
                    console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢å·²æ¿€æ´»');
                }
                if (chatContainer) chatContainer.style.display = 'none';

                // å»¶è¿Ÿè®¾ç½®è¾“å…¥æ¡†æ ·å¼ï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆ
                setTimeout(() => {
                    const inputArea = document.querySelector('.input-area');
                    if (inputArea) {
                        console.log('ğŸ”¥ showWelcomeScreen å¼€å§‹è®¾ç½®è¾“å…¥æ¡†æ ·å¼');

                        // å…ˆå¼ºåˆ¶æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ ·å¼
                        inputArea.style.cssText = '';

                        // ä¿æŒè¾“å…¥æ¡†åœ¨åŸå§‹ä½ç½®ï¼Œåªè°ƒæ•´å†…éƒ¨æ ·å¼
                        inputArea.style.setProperty('background-color', 'transparent', 'important');
                        inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ä¸‹è°ƒ50pxï¼Œè°ƒæ•´ä¸º-250px */
                        inputArea.style.setProperty('padding-top', '0', 'important');
                        inputArea.style.setProperty('padding-bottom', '0', 'important');
                        inputArea.style.setProperty('margin-bottom', '0', 'important');

                        console.log('ğŸ”¥ showWelcomeScreen è¾“å…¥æ¡†æ ·å¼å·²è®¾ç½®');
                        console.log('ğŸ”¥ å½“å‰marginTop:', inputArea.style.marginTop);

                        // éªŒè¯è®¡ç®—æ ·å¼
                        const computedStyle = window.getComputedStyle(inputArea);
                        console.log('ğŸ”¥ è®¡ç®—åçš„marginTop:', computedStyle.marginTop);
                    } else {
                        console.error('ğŸ”¥ showWelcomeScreen æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ï¼');
                    }
                }, 100);
            }

            clearMessages() {
                chatManager.messagesContainer.innerHTML = '';
            }
        }

        // ä¸»åº”ç”¨ç®¡ç†
        class AppManager {
            constructor() {
                this.loginPage = document.getElementById('login-page');
                this.mainPage = document.getElementById('main-page');
                this.init();
            }

            init() {
                // åŠ è½½ä¿å­˜çš„çŠ¶æ€
                appState.loadState();

                // åˆå§‹åŒ–å„ä¸ªç®¡ç†å™¨
                window.modalManager = new ModalManager();
                window.loginManager = new LoginManager();
                window.welcomeManager = new WelcomeManager();
                window.sidebarManager = new SidebarManager();
                window.chatManager = new ChatManager();

                // æ ¹æ®ç™»å½•çŠ¶æ€æ˜¾ç¤ºå¯¹åº”é¡µé¢
                if (appState.isLoggedIn) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é¡µé¢åˆ·æ–°ï¼ˆé€šè¿‡æ£€æŸ¥performance.navigationæˆ–å…¶ä»–æ–¹å¼ï¼‰
                    const isPageRefresh = performance.getEntriesByType &&
                                         performance.getEntriesByType('navigation').length > 0 &&
                                         performance.getEntriesByType('navigation')[0].type === 'reload';

                    console.log('ğŸ”¥ é¡µé¢åŠ è½½ç±»å‹:', isPageRefresh ? 'åˆ·æ–°' : 'é¦–æ¬¡åŠ è½½');
                    this.showMainPage(isPageRefresh);
                } else {
                    this.showLoginPage();
                }

                // ç»‘å®šå…¨å±€äº‹ä»¶
                this.bindGlobalEvents();
            }

            bindGlobalEvents() {
                // å“åº”å¼å¤„ç†
                window.addEventListener('resize', utils.debounce(() => {
                    this.handleResize();
                }, 250));

                // å¤‡ç”¨logoç‚¹å‡»äº‹ä»¶ç»‘å®šï¼ˆç¡®ä¿é¡µé¢åˆ·æ–°åä¹Ÿèƒ½å·¥ä½œï¼‰
                setTimeout(() => {
                    this.bindBrandClickGlobal();
                }, 200);

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboardShortcuts(e);
                });
            }

            handleResize() {
                // å“åº”å¼é€»è¾‘
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.add('collapsed');
                        appState.sidebarCollapsed = true;
                    }
                }
            }

            handleKeyboardShortcuts(e) {
                // Ctrl/Cmd + N æ–°å»ºå¯¹è¯
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    if (window.sidebarManager) {
                        window.sidebarManager.createNewChat();
                    }
                }
            }

            bindBrandClickGlobal() {
                // å…¨å±€å¤‡ç”¨çš„logoç‚¹å‡»äº‹ä»¶ç»‘å®š
                const brandInfos = document.querySelectorAll('.brand-info');
                console.log('ğŸ”¥ bindBrandClickGlobal - å…¨å±€ç»‘å®šlogoç‚¹å‡»äº‹ä»¶ï¼Œæ‰¾åˆ°å…ƒç´ æ•°é‡:', brandInfos.length);

                brandInfos.forEach((brandInfo, index) => {
                    // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
                    if (brandInfo._brandClickHandler) {
                        brandInfo.removeEventListener('click', brandInfo._brandClickHandler);
                    }

                    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                    const clickHandler = (e) => {
                        console.log('ğŸ”¥ å…¨å±€brand-infoè¢«ç‚¹å‡»:', index);
                        console.log('ğŸ”¥ ç‚¹å‡»ç›®æ ‡:', e.target);

                        // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯å…¶ä»–æŒ‰é’®æˆ–å¯äº¤äº’å…ƒç´ 
                        const isButton = e.target.closest('button');
                        const isUserMenu = e.target.closest('.user-menu');

                        if (!isButton && !isUserMenu) {
                            console.log('ğŸ”¥ å…¨å±€è§¦å‘æ–°å»ºå¯¹è¯');
                            if (window.sidebarManager) {
                                window.sidebarManager.createNewChat();
                            } else {
                                console.error('ğŸ”¥ sidebarManager ä¸å­˜åœ¨');
                            }
                        } else {
                            console.log('ğŸ”¥ ç‚¹å‡»äº†æŒ‰é’®æˆ–ç”¨æˆ·èœå•ï¼Œä¸è§¦å‘æ–°å»ºå¯¹è¯');
                        }
                    };

                    brandInfo.addEventListener('click', clickHandler);

                    // ä¿å­˜å¤„ç†å™¨å¼•ç”¨ä»¥ä¾¿åç»­æ¸…ç†
                    brandInfo._brandClickHandler = clickHandler;

                    // ç¡®ä¿æ ·å¼æ­£ç¡®
                    brandInfo.style.cursor = 'pointer';
                    brandInfo.title = 'ç‚¹å‡»æ–°å»ºå¯¹è¯';

                    const brandElements = brandInfo.querySelectorAll('*');
                    brandElements.forEach(el => {
                        el.style.cursor = 'pointer';
                        el.title = 'ç‚¹å‡»æ–°å»ºå¯¹è¯';
                    });
                });
            }

            showLoginPage() {
                if (this.loginPage) this.loginPage.classList.add('active');
                if (this.mainPage) this.mainPage.classList.remove('active');
                appState.currentPage = 'login';
            }

            showMainPage(isPageRefresh = false) {
                if (this.loginPage) this.loginPage.classList.remove('active');
                if (this.mainPage) this.mainPage.classList.add('active');
                appState.currentPage = 'main';

                // è®¾ç½®ç”¨æˆ·åæ˜¾ç¤º
                const userNameEl = document.getElementById('user-name');
                if (userNameEl) userNameEl.textContent = appState.userName;

                // è®¾ç½®æ·±åº¦æ€è€ƒå¼€å…³çŠ¶æ€ - åŒæ­¥åŸè¾“å…¥æ¡†å’Œæ–°è¾“å…¥æ¡†
                const deepThinkingEl = document.getElementById('deep-thinking-checkbox');
                const welcomeDeepThinkingEl = document.getElementById('welcome-deep-thinking-checkbox');
                if (deepThinkingEl) deepThinkingEl.checked = appState.deepThinkingEnabled;
                if (welcomeDeepThinkingEl) welcomeDeepThinkingEl.checked = appState.deepThinkingEnabled;

                // ç¡®ä¿æ¬¢è¿ç•Œé¢åˆå§‹çŠ¶æ€æ­£ç¡®å¹¶è®¾ç½®è¾“å…¥æ¡†ä½ç½®
                const welcomeScreen = document.getElementById('welcome-screen');
                if (welcomeScreen) {
                    welcomeScreen.style.display = 'flex';
                    welcomeScreen.classList.add('active');
                    console.log('ğŸ”¥ showMainPage æ¿€æ´»æ¬¢è¿ç•Œé¢');

                    // å»¶è¿Ÿè®¾ç½®è¾“å…¥æ¡†ä½ç½®ï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆ
                    setTimeout(() => {
                        const inputArea = document.querySelector('.input-area');
                        if (inputArea) {
                            console.log('ğŸ”¥ showMainPage å¼€å§‹è®¾ç½®è¾“å…¥æ¡†æ ·å¼');

                            // å…ˆå¼ºåˆ¶æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ ·å¼
                            inputArea.style.cssText = '';

                            // è®¾ç½®è¾“å…¥æ¡†ä½ç½®
                            inputArea.style.setProperty('background-color', 'transparent', 'important');
                            inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ä¸‹è°ƒ50pxï¼Œè°ƒæ•´ä¸º-250px */
                            inputArea.style.setProperty('padding-top', '0', 'important');
                            inputArea.style.setProperty('padding-bottom', '0', 'important');
                            inputArea.style.setProperty('margin-bottom', '0', 'important');

                            console.log('ğŸ”¥ showMainPage è¾“å…¥æ¡†æ ·å¼å·²è®¾ç½®');
                            console.log('ğŸ”¥ è®¾ç½®åçš„marginTop:', inputArea.style.marginTop);
                        } else {
                            console.error('ğŸ”¥ showMainPage æ‰¾ä¸åˆ°inputAreaå…ƒç´ ï¼');
                        }
                    }, 200); // å¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿DOMå®Œå…¨æ›´æ–°
                } else {
                    console.error('ğŸ”¥ showMainPage æ‰¾ä¸åˆ°welcomeScreenå…ƒç´ ï¼');
                }

                // å¦‚æœæ˜¯é¡µé¢åˆ·æ–°ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯ï¼ˆç±»ä¼¼ç‚¹å‡»æ–°å»ºå¯¹è¯æŒ‰é’®ï¼‰
                if (isPageRefresh) {
                    console.log('ğŸ”¥ é¡µé¢åˆ·æ–°ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯');
                    setTimeout(() => {
                        if (window.sidebarManager) {
                            window.sidebarManager.createNewChat();
                        } else {
                            console.error('ğŸ”¥ sidebarManager ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºæ–°å¯¹è¯');
                        }
                    }, 100); // ç¨å¾®å»¶è¿Ÿç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½åˆå§‹åŒ–å®Œæˆ
                }
            }
        }

        // å¯åŠ¨åº”ç”¨
        let appManager;

        document.addEventListener('DOMContentLoaded', () => {
            appManager = new AppManager();
            window.appManager = appManager;
            console.log('AIäº§å“ä¸“å®¶ Demo å·²å¯åŠ¨');

            // ä¼˜åŒ–çš„å…¨å±€ç›‘å¬å™¨ï¼šç¡®ä¿è¾“å…¥æ¡†ä½ç½®æ­£ç¡®ï¼Œé¿å…é‡å¤è®¾ç½®
            let lastWelcomeScreenState = false;
            setInterval(() => {
                const welcomeScreen = document.getElementById('welcome-screen');
                const inputArea = document.querySelector('.input-area');

                // æ›´å‡†ç¡®çš„æ¬¢è¿ç•Œé¢çŠ¶æ€æ£€æµ‹
                const isWelcomeScreenVisible = welcomeScreen &&
                    welcomeScreen.style.display !== 'none' &&
                    !welcomeScreen.classList.contains('hidden') &&
                    welcomeScreen.classList.contains('active');

                // åªåœ¨æ¬¢è¿ç•Œé¢çŠ¶æ€å˜åŒ–æ—¶è®¾ç½®æ ·å¼
                if (isWelcomeScreenVisible !== lastWelcomeScreenState && inputArea) {
                    lastWelcomeScreenState = isWelcomeScreenVisible;

                    if (isWelcomeScreenVisible) {
                        console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢æ˜¾ç¤ºï¼Œè°ƒæ•´è¾“å…¥æ¡†æ ·å¼');
                        inputArea.style.setProperty('background-color', 'transparent', 'important');
                        inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ä¸‹è°ƒ50pxï¼Œè°ƒæ•´ä¸º-250px */
                        inputArea.style.setProperty('padding-top', '0', 'important');
                        inputArea.style.setProperty('padding-bottom', '0', 'important');
                        inputArea.style.setProperty('margin-bottom', '0', 'important');
                    } else {
                        console.log('ğŸ”¥ æ¬¢è¿ç•Œé¢éšè—ï¼Œæ¢å¤è¾“å…¥æ¡†æ ·å¼');
                        inputArea.style.cssText = ''; // æ¸…é™¤æ‰€æœ‰è®¾ç½®
                    }
                }

                // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœæ˜¯ç™»å½•ååˆšå¼€å§‹ï¼Œå¼ºåˆ¶è®¾ç½®ä¸€æ¬¡
                if (isWelcomeScreenVisible && inputArea && lastWelcomeScreenState === false) {
                    console.log('ğŸ”¥ å¼ºåˆ¶æ£€æŸ¥ï¼šæ¬¢è¿ç•Œé¢æ˜¾ç¤ºä½†ä¸Šæ¬¡çŠ¶æ€ä¸ºfalseï¼Œé‡æ–°è®¾ç½®è¾“å…¥æ¡†æ ·å¼');
                    // ä½¿ç”¨cssTextç¡®ä¿å®Œå…¨è¦†ç›–
                    inputArea.style.cssText = `
                        margin-top: -250px !important;
                        background-color: transparent !important;
                        padding-top: 0 !important;
                        padding-bottom: 0 !important;
                        margin-bottom: 0 !important;
                    `;
                    lastWelcomeScreenState = true;
                }
            }, 200); // å¢åŠ æ£€æŸ¥é¢‘ç‡ï¼Œæ¯200msæ£€æŸ¥ä¸€æ¬¡
        });
    </script>
    <!-- æ·»åŠ jsPDFåº“ç”¨äºPDFå¯¼å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>