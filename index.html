<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI‰∫ßÂìÅ‰∏ìÂÆ∂ - Êô∫ËÉΩÊ∂¶ÊªëÊ≤πÂí®ËØ¢Âä©Êâã">
    <meta name="theme-color" content="#4d6bfe">
    <title>AI‰∫ßÂìÅ‰∏ìÂÆ∂</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app">
        <!-- ÁôªÂΩïÈ°µÈù¢ -->
        <div id="login-page" class="page active">
            <div class="login-container">
                <div class="login-content">
                    <div class="brand-section">
                        <img src="assets/images/logo.png" alt="AI‰∫ßÂìÅ‰∏ìÂÆ∂" class="brand-logo">
                        <h1 class="brand-title">AI‰∫ßÂìÅ‰∏ìÂÆ∂</h1>
                        <p class="brand-subtitle">ÊÇ®ÁöÑÊô∫ËÉΩÊ∂¶ÊªëÊ≤πÂí®ËØ¢Âä©Êâã</p>
                    </div>

                    <div class="login-actions">
                        <button class="login-btn primary" id="wechat-login-btn">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 4.882-1.786 7.267-.736-.847-3.206-4.468-5.49-8.91-5.49z"/>
                                <path d="M15.309 9.53c-4.337 0-7.891 2.746-7.891 6.053 0 3.307 3.554 6.053 7.891 6.053.875 0 1.713-.144 2.484-.398a.7.7 0 0 1 .832.232l1.521 1.114a.253.253 0 0 0 .147.043c.12 0 .217-.1.217-.225 0-.06-.023-.12-.038-.177l-.313-1.332a.427.427 0 0 1 .154-.485c1.724-1.224 2.887-2.998 2.887-5.025 0-3.307-3.554-6.053-7.891-6.053z"/>
                            </svg>
                            ÂæÆ‰ø°Êâ´Á†ÅÁôªÂΩï
                        </button>
                        <button class="login-btn secondary" id="dingtalk-login-btn">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            ÈíâÈíâÊâ´Á†ÅÁôªÂΩï
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÁïåÈù¢ -->
        <div id="main-page" class="page">
            <!-- Â∑¶‰æßÂäüËÉΩÂå∫ -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="brand-info">
                        <img src="assets/images/logo.png" alt="AI‰∫ßÂìÅ‰∏ìÂÆ∂" class="brand-logo">
                        <span class="brand-text">AI‰∫ßÂìÅ‰∏ìÂÆ∂</span>
                    </div>
                    <div class="header-actions">
                        <button class="new-chat-btn-mini" id="new-chat-btn-mini" style="display: none;">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </button>
                        <button class="sidebar-toggle" id="sidebar-toggle">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12h18M3 6h18M3 18h18"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="sidebar-content">
                    <button class="new-chat-btn" id="new-chat-btn">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Êñ∞Âª∫ÂØπËØù
                    </button>

                    <div class="chat-history">
                        <div class="history-header">
                            <h3>ÂéÜÂè≤ÊñπÊ°àÂ∫ì</h3>
                        </div>
                        <div class="history-list" id="history-list">
                            <!-- ÂéÜÂè≤ÂØπËØùÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <div class="user-menu">
                        <button class="user-btn" id="user-menu-btn">
                            <div class="user-avatar">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <span class="user-name" id="user-name">Simon</span>
                            <svg class="icon dropdown" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="user-dropdown">
                            <button class="dropdown-item" id="feedback-btn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                                ÂèçÈ¶à‰∏éÂ∏ÆÂä©
                            </button>
                            <button class="dropdown-item" id="logout-btn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                                </svg>
                                ÈÄÄÂá∫ÁôªÂΩï
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
            <main class="main-content">
                <!-- È°∂ÈÉ®ËèúÂçïÊ†è -->
                <header class="top-header" id="top-header">
                    <div class="top-header-left">
                        <div class="brand-info">
                            <img src="assets/images/logo.png" alt="AI‰∫ßÂìÅ‰∏ìÂÆ∂" class="brand-logo">
                            <span class="brand-text">AI‰∫ßÂìÅ‰∏ìÂÆ∂</span>
                        </div>
                        <button class="combined-action-btn" id="combined-action-btn">
                            <svg class="icon expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12h18M3 6h18M3 18h18"/>
                            </svg>
                            <svg class="icon new-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </button>
                    </div>
                    <div class="top-header-actions">
                        <!-- Âè≥‰æßÂÖ∂‰ªñÊìç‰ΩúÊåâÈíÆÂèØ‰ª•ÊîæÂú®ËøôÈáå -->
                    </div>
                </header>
                <!-- Ê¨¢ËøéÁïåÈù¢ -->
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-content">
                        <div class="welcome-text-container">
                            <div class="welcome-text">
                                <img src="assets/images/logo.png" alt="AI‰∫ßÂìÅ‰∏ìÂÆ∂" class="welcome-logo">
                                <h2 class="typing-text" id="welcome-text"></h2>
                            </div>
                            <!-- ÂìÅÁâåIPÂΩ¢Ë±° -->
                            <div class="brand-mascot">
                                <img src="assets/images/mascot.gif" alt="ÂÆâÂÆâ" class="mascot-image">
                            </div>
                        </div>

                        <!-- Êñ∞ÁöÑËæìÂÖ•Ê°Ü - ‰∏éÂø´Êç∑Âç°Áâá‰∏Ä‰Ωì -->
                        <div class="welcome-input-container">
                            <div class="welcome-input-wrapper">
                                <textarea
                                    class="welcome-message-input"
                                    id="welcome-message-input"
                                    placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò... Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°å"
                                    rows="2"
                                ></textarea>
                                <div class="welcome-input-actions">
                                    <label class="welcome-deep-thinking-toggle">
                                        <input type="checkbox" id="welcome-deep-thinking-checkbox">
                                        <span class="toggle-label">Ê∑±Â∫¶ÊÄùËÄÉ</span>
                                    </label>
                                    <button class="welcome-send-btn" id="welcome-send-btn">
                                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="task-cards">
                            <div class="task-card" data-task="product-query">
                                <div class="card-icon">üîç</div>
                                <div class="task-card-content">
                                    <h3>‰∫ßÂìÅÂèÇÊï∞ÈÄüÊü•</h3>
                                    <p>Âø´ÈÄüÊü•ËØ¢Ê∂¶ÊªëÊ≤π‰∫ßÂìÅÊäÄÊúØÂèÇÊï∞ÂíåËßÑÊ†º‰ø°ÊÅØ</p>
                                </div>
                            </div>
                            <div class="task-card" data-task="competitor-comparison">
                                <div class="card-icon">üìä</div>
                                <div class="task-card-content">
                                    <h3>ÁîüÊàêÁ´ûÂìÅÂØπÊØîË°®</h3>
                                    <p>ÂØπÊØî‰∏çÂêåÂìÅÁâå‰∫ßÂìÅÁöÑÊÄßËÉΩÂíåÁâπÁÇπ</p>
                                </div>
                            </div>
                            <div class="task-card" data-task="scenario-solution">
                                <div class="card-icon">üè≠</div>
                                <div class="task-card-content">
                                    <h3>ÂàõÂª∫Âú∫ÊôØÊñπÊ°à</h3>
                                    <p>ÈíàÂØπÂÖ∑‰ΩìÂ∑•ÂÜµÊèê‰æõÊ∂¶ÊªëËß£ÂÜ≥ÊñπÊ°à</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ËÅäÂ§©ÁïåÈù¢ -->
                <div class="chat-container" id="chat-container">
                    <div class="messages-area" id="messages-area">
                        <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="input-area">
                    <div class="quick-actions" id="quick-actions">
                        <!-- Âø´Êç∑‰ªªÂä°ÊåâÈíÆ -->
                    </div>
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea
                                class="message-input"
                                id="message-input"
                                placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò... Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°å"
                                rows="2"
                            ></textarea>
                            <div class="input-actions">
                                <label class="deep-thinking-toggle">
                                    <input type="checkbox" id="deep-thinking-checkbox">
                                    <span class="toggle-label">Ê∑±Â∫¶ÊÄùËÄÉ</span>
                                </label>
                                <button class="send-btn" id="send-btn">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Ê®°ÊÄÅÂºπÁ™ó -->
        <div class="modal-overlay" id="modal-overlay">
            <!-- ÂºπÁ™óÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>

    <script>
        // ÂÜÖËÅîÊâÄÊúâJavaScript‰ª£Á†Å
        // Â∫îÁî®Áä∂ÊÄÅÁÆ°ÁêÜ
        class AppState {
            constructor() {
                this.currentPage = 'login';
                this.userName = 'Simon';
                this.isLoggedIn = false;
                this.currentChatId = null;
                this.chatHistory = [];
                this.sidebarCollapsed = false;
                this.deepThinkingEnabled = false;
                this.welcomeText = '';
                this.welcomeIndex = 0;
                this.isTyping = false;
            }

            // ‰øùÂ≠òÁä∂ÊÄÅÂà∞localStorage
            saveState() {
                try {
                    const state = {
                        userName: this.userName,
                        isLoggedIn: this.isLoggedIn,
                        chatHistory: this.chatHistory,
                        currentChatId: this.currentChatId
                    };
                    localStorage.setItem('aiProductExpertState', JSON.stringify(state));
                } catch (error) {
                    console.warn('Êó†Ê≥ï‰øùÂ≠òÂà∞localStorage:', error);
                    // Âú®localStorage‰∏çÂèØÁî®Êó∂Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®
                    this.tempState = {
                        userName: this.userName,
                        isLoggedIn: this.isLoggedIn,
                        chatHistory: this.chatHistory,
                        currentChatId: this.currentChatId
                    };
                }
            }

            // ‰ªélocalStorageÂä†ËΩΩÁä∂ÊÄÅ
            loadState() {
                try {
                    const savedState = localStorage.getItem('aiProductExpertState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        Object.assign(this, state);
                    }
                } catch (error) {
                    console.warn('Êó†Ê≥ï‰ªélocalStorageÂä†ËΩΩÁä∂ÊÄÅ:', error);
                    // Â∞ùËØï‰ªé‰∏¥Êó∂Áä∂ÊÄÅÊÅ¢Â§ç
                    if (this.tempState) {
                        Object.assign(this, this.tempState);
                    }
                }
            }

            // Ê∏ÖÈô§Áä∂ÊÄÅ
            clearState() {
                try {
                    localStorage.removeItem('aiProductExpertState');
                } catch (error) {
                    console.warn('Êó†Ê≥ïÊ∏ÖÈô§localStorage:', error);
                }
                this.tempState = null;
                this.userName = 'Simon';
                this.isLoggedIn = false;
                this.currentChatId = null;
                this.chatHistory = [];
            }
        }

        // ÂÖ®Â±ÄÁä∂ÊÄÅÂÆû‰æã
        const appState = new AppState();

        // Â∑•ÂÖ∑ÂáΩÊï∞
        const utils = {
            // ÁîüÊàêÂîØ‰∏ÄID
            generateId() {
                return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // Ê†ºÂºèÂåñÊó∂Èó¥
            formatTime(date) {
                // Á°Æ‰øùdateÊòØDateÂØπË±°
                if (!(date instanceof Date)) {
                    date = new Date(date);
                }

                // Ê£ÄÊü•Êó•ÊúüÊòØÂê¶ÊúâÊïà
                if (isNaN(date.getTime())) {
                    return 'Êú™Áü•Êó∂Èó¥';
                }

                const now = new Date();
                const diff = now - date;

                if (diff < 60000) {
                    return 'ÂàöÂàö';
                } else if (diff < 3600000) {
                    return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
                } else if (diff < 86400000) {
                    return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
                } else {
                    return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                }
            },

            // Èò≤ÊäñÂáΩÊï∞
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // ÊòæÁ§∫ToastÈÄöÁü•
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            // Â§çÂà∂ÊñáÊú¨Âà∞Ââ™Ë¥¥Êùø
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    utils.showToast('Â§çÂà∂ÊàêÂäü', 'success');
                } catch (err) {
                    // ÈôçÁ∫ßÊñπÊ°à
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    utils.showToast('Â§çÂà∂ÊàêÂäü', 'success');
                }
            },

            // ËΩ¨‰πâHTML
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            },

            // ÁÆÄÂçïÁöÑMarkdownËß£ÊûêÂáΩÊï∞
            parseMarkdown(text) {
                if (!text) return '';

                let html = text;

                // Â§ÑÁêÜÊ†áÈ¢ò (# ## ### Á≠â)
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                // Â§ÑÁêÜÁ≤ó‰Ωì **text**
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

                // Â§ÑÁêÜÊñú‰Ωì *text*
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

                // Â§ÑÁêÜ‰ª£Á†ÅÂùó `code`
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

                // Â§ÑÁêÜÊó†Â∫èÂàóË°® - item
                html = html.replace(/^- (.+)$/gim, '<li>$1</li>');

                // Â∞ÜËøûÁª≠ÁöÑliÂåÖË£ÖÂú®ul‰∏≠
                html = html.replace(/(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/g, '<ul>$&</ul>');

                // Â§ÑÁêÜÊç¢Ë°å
                html = html.replace(/\n\n/g, '</p><p>');
                html = html.replace(/\n/g, '<br>');

                // Â¶ÇÊûú‰∏çÂåÖÂê´HTMLÊ†áÁ≠æÔºåÂåÖË£ÖÂú®ÊÆµËêΩ‰∏≠
                if (!html.includes('<h') && !html.includes('<ul>') && !html.includes('<p>')) {
                    html = '<p>' + html + '</p>';
                }

                return html;
            }
        };

        // ÊâìÂ≠óÊú∫ÊïàÊûú
        class TypingEffect {
            constructor(element, text, speed = 120) {
                this.element = element;
                this.text = text;
                this.speed = speed;
                this.index = 0;
                this.isRunning = false;
                this.onComplete = null;
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.element.innerHTML = '';
                this.type();
            }

            type() {
                if (this.index < this.text.length) {
                    this.element.innerHTML = this.text.substring(0, this.index + 1) + '<span class="typing-cursor"></span>';
                    this.index++;
                    setTimeout(() => this.type(), this.speed);
                } else {
                    this.element.innerHTML = this.text;
                    this.isRunning = false;
                    if (this.onComplete) {
                        this.onComplete();
                    }
                }
            }

            stop() {
                this.isRunning = false;
            }
        }

        // ÂØåÊñáÊú¨ÊâìÂ≠óÊú∫ÊïàÊûúÔºàÊîØÊåÅMarkdownÔºâ
        class RichTextTypingEffect {
            constructor(element, markdownText, speed = 10) {
                this.element = element;
                this.originalText = markdownText;
                this.speed = speed;
                this.index = 0;
                this.isRunning = false;
                this.onComplete = null;
                this.htmlContent = utils.parseMarkdown(markdownText);
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.element.innerHTML = '';
                this.type();
            }

            type() {
                if (this.index < this.htmlContent.length) {
                    // Â§ÑÁêÜHTMLÊ†áÁ≠æÔºåÁ°Æ‰øùÊ†áÁ≠æÂÆåÊï¥ÊÄß
                    let currentContent = this.htmlContent.substring(0, this.index + 1);

                    // Á°Æ‰øù‰∏çÊà™Êñ≠HTMLÊ†áÁ≠æ
                    const openTagCount = (currentContent.match(/</g) || []).length;
                    const closeTagCount = (currentContent.match(/>/g) || []).length;

                    if (openTagCount > closeTagCount) {
                        // Â¶ÇÊûúÊ†áÁ≠æÊú™Èó≠ÂêàÔºåÊâæÂà∞‰∏ã‰∏Ä‰∏™Èó≠ÂêàÊ†áÁ≠æ
                        const nextCloseTag = this.htmlContent.indexOf('>', this.index);
                        if (nextCloseTag !== -1) {
                            this.index = nextCloseTag;
                        }
                    }

                    this.element.innerHTML = this.htmlContent.substring(0, this.index + 1) + '<span class="typing-cursor"></span>';
                    this.index++;
                    setTimeout(() => this.type(), this.speed);
                } else {
                    this.element.innerHTML = this.htmlContent;
                    this.isRunning = false;
                    if (this.onComplete) {
                        this.onComplete();
                    }
                }
            }

            stop() {
                this.isRunning = false;
            }
        }

        // Ê®°ÊÄÅÊ°ÜÁÆ°ÁêÜ
        class ModalManager {
            constructor() {
                this.overlay = document.getElementById('modal-overlay');
                this.currentModal = null;
                this.init();
            }

            init() {
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.close();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.currentModal) {
                        this.close();
                    }
                });
            }

            show(content) {
                this.overlay.innerHTML = content;
                this.overlay.classList.add('show');
                this.currentModal = this.overlay.querySelector('.modal');
                this.bindEvents();
            }

            close() {
                this.overlay.classList.remove('show');
                this.currentModal = null;
            }

            bindEvents() {
                const closeBtn = this.overlay.querySelector('.modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.close());
                }

                const cancelBtns = this.overlay.querySelectorAll('.btn-secondary');
                cancelBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.close());
                });
            }
        }

        // ÁôªÂΩïÁÆ°ÁêÜ
        class LoginManager {
            constructor() {
                this.init();
            }

            init() {
                document.getElementById('wechat-login-btn').addEventListener('click', () => {
                    this.handleLogin('wechat');
                });

                document.getElementById('dingtalk-login-btn').addEventListener('click', () => {
                    this.handleLogin('dingtalk');
                });
            }

            handleLogin(provider) {
                // Ê®°ÊãüÁôªÂΩïËøáÁ®ã
                const btn = provider === 'wechat' ?
                    document.getElementById('wechat-login-btn') :
                    document.getElementById('dingtalk-login-btn');

                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> ÁôªÂΩï‰∏≠...';

                setTimeout(() => {
                    appState.isLoggedIn = true;
                    appState.saveState();

                    utils.showToast(`‰ΩøÁî®${provider === 'wechat' ? 'ÂæÆ‰ø°' : 'ÈíâÈíâ'}ÁôªÂΩïÊàêÂäü`, 'success');

                    setTimeout(() => {
                        // ÂàáÊç¢Âà∞‰∏ªÁïåÈù¢
                        document.getElementById('login-page').classList.remove('active');
                        document.getElementById('main-page').classList.add('active');
                        document.getElementById('user-name').textContent = appState.userName;
                        utils.showToast('ÁôªÂΩïÊàêÂäüÔºåÊ¨¢Ëøé‰ΩøÁî®AI‰∫ßÂìÅ‰∏ìÂÆ∂ÔºÅ', 'success');

                        console.log('üî• ÁôªÂΩïÊàêÂäüÔºåÂºÄÂßãÂ§öÈò∂ÊÆµËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆ');

                        // Â§öÈò∂ÊÆµÂº∫Âà∂ËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË¢´Ë¶ÜÁõñ
                        const setInputBoxPosition = () => {
                            const welcomeScreen = document.getElementById('welcome-screen');
                            const inputArea = document.querySelector('.input-area');

                            if (welcomeScreen) {
                                welcomeScreen.style.display = 'flex';
                                welcomeScreen.classList.add('active');
                                console.log('üî• ËÆæÁΩÆÊ¨¢ËøéÁïåÈù¢ÊòæÁ§∫');
                            }

                            if (inputArea) {
                                // ‰ΩøÁî®ÊúÄÂº∫Âà∂ÁöÑÊñπÂºèËÆæÁΩÆÊ†∑Âºè
                                inputArea.style.cssText = `
                                    margin-top: -250px !important;
                                    background-color: transparent !important;
                                    padding-top: 0 !important;
                                    padding-bottom: 0 !important;
                                    margin-bottom: 0 !important;
                                `;
                                console.log('üî• Âº∫Âà∂ËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆ: margin-top: -250px');
                            }
                        };

                        // Á´ãÂç≥ËÆæÁΩÆ‰∏ÄÊ¨°
                        setInputBoxPosition();

                        // 300msÂêéÂÜçËÆæÁΩÆ‰∏ÄÊ¨°
                        setTimeout(setInputBoxPosition, 300);

                        // 600msÂêéÂÜçËÆæÁΩÆ‰∏ÄÊ¨°
                        setTimeout(setInputBoxPosition, 600);

                        // 1000msÂêéÂÜçËÆæÁΩÆ‰∏ÄÊ¨°ÔºåÁ°Æ‰øùÂÆåÂÖ®Ë¶ÜÁõñ
                        setTimeout(setInputBoxPosition, 1000);

                        // Ëß¶Âèë‰∏ªÁïåÈù¢ÂàùÂßãÂåñ
                        if (window.appManager) {
                            console.log('üî• ÁôªÂΩïÊàêÂäüÔºåË∞ÉÁî®showMainPage');
                            window.appManager.showMainPage(false);
                        }
                    }, 1000);
                }, 1500);
            }
        }

        // ËÅäÂ§©ÁÆ°ÁêÜ
        class ChatManager {
            constructor() {
                this.messagesContainer = document.getElementById('messages-area');
                this.messageInput = document.getElementById('message-input');
                this.sendBtn = document.getElementById('send-btn');
                this.deepThinkingCheckbox = document.getElementById('deep-thinking-checkbox');

                // Êñ∞Â¢ûÊ¨¢ËøéÁïåÈù¢ÁöÑËæìÂÖ•Ê°ÜÂÖÉÁ¥†
                this.welcomeMessageInput = document.getElementById('welcome-message-input');
                this.welcomeSendBtn = document.getElementById('welcome-send-btn');
                this.welcomeDeepThinkingCheckbox = document.getElementById('welcome-deep-thinking-checkbox');

                this.currentTypingEffect = null;
                this.init();
            }

            init() {
                // ÂéüËæìÂÖ•Ê°Ü‰∫ã‰ª∂ÁªëÂÆö
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keydown', (e) => {
                    // Enter ÂèëÈÄÅÊ∂àÊÅØÔºåShift+Enter Êç¢Ë°å
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                    // Shift+Enter ÂÖÅËÆ∏Êç¢Ë°åÔºàÈªòËÆ§Ë°å‰∏∫Ôºâ
                });

                this.messageInput.addEventListener('input', () => {
                    this.autoResize();
                });

                this.deepThinkingCheckbox.addEventListener('change', (e) => {
                    appState.deepThinkingEnabled = e.target.checked;
                });

                // Êñ∞Â¢ûÊ¨¢ËøéÁïåÈù¢ËæìÂÖ•Ê°Ü‰∫ã‰ª∂ÁªëÂÆö
                if (this.welcomeSendBtn && this.welcomeMessageInput) {
                    this.welcomeSendBtn.addEventListener('click', () => this.sendMessageFromWelcome());
                    this.welcomeMessageInput.addEventListener('keydown', (e) => {
                        // Enter ÂèëÈÄÅÊ∂àÊÅØÔºåShift+Enter Êç¢Ë°å
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessageFromWelcome();
                        }
                        // Shift+Enter ÂÖÅËÆ∏Êç¢Ë°åÔºàÈªòËÆ§Ë°å‰∏∫Ôºâ
                    });

                    this.welcomeMessageInput.addEventListener('input', () => {
                        this.autoResizeWelcome();
                    });

                    this.welcomeDeepThinkingCheckbox.addEventListener('change', (e) => {
                        appState.deepThinkingEnabled = e.target.checked;
                    });
                }
            }

            autoResize() {
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
            }

            autoResizeWelcome() {
                if (this.welcomeMessageInput) {
                    this.welcomeMessageInput.style.height = 'auto';
                    this.welcomeMessageInput.style.height = Math.min(this.welcomeMessageInput.scrollHeight, 180) + 'px'; // Êõ¥Êñ∞‰∏∫180px
                }
            }

            async sendMessageFromWelcome() {
                console.log('üî• sendMessageFromWelcome ÂºÄÂßãÊâßË°å');
                const text = this.welcomeMessageInput.value.trim();
                console.log('üî• Ê¨¢ËøéÁïåÈù¢ËæìÂÖ•ÊñáÊú¨:', text);
                if (!text) {
                    console.log('üî• Ê¨¢ËøéÁïåÈù¢ËæìÂÖ•‰∏∫Á©∫ÔºåÈÄÄÂá∫');
                    return;
                }

                // Â∞ÜÊñáÊú¨Â§çÂà∂Âà∞ÂéüËæìÂÖ•Ê°ÜÂπ∂ÂèëÈÄÅ
                this.messageInput.value = text;
                await this.sendMessage();

                // Ê∏ÖÁ©∫Ê¨¢ËøéÁïåÈù¢ËæìÂÖ•Ê°Ü
                this.welcomeMessageInput.value = '';
                this.autoResizeWelcome();
            }

            async sendMessage() {
                console.log('üî• sendMessage ÂºÄÂßãÊâßË°å');
                const text = this.messageInput.value.trim();
                console.log('üî• ËæìÂÖ•ÊñáÊú¨:', text);
                if (!text) {
                    console.log('üî• ËæìÂÖ•‰∏∫Á©∫ÔºåÈÄÄÂá∫');
                    return;
                }

                // ÂàõÂª∫ÊàñËé∑ÂèñÂΩìÂâçËÅäÂ§©
                let isNewChat = false;
                console.log('üî• ÂΩìÂâçÂØπËØùID:', appState.currentChatId);
                if (!appState.currentChatId) {
                    console.log('üî• Ê≤°ÊúâÂΩìÂâçÂØπËØùÔºåÂàõÂª∫Êñ∞ÂØπËØù');
                    appState.currentChatId = utils.generateId();
                    const newChat = {
                        id: appState.currentChatId,
                        title: this.generateChatTitle(text),
                        messages: [],
                        createdAt: new Date()
                    };
                    appState.chatHistory.unshift(newChat);
                    // Á´ãÂç≥‰øùÂ≠òÊñ∞ÂàõÂª∫ÁöÑÂØπËØù
                    appState.saveState();
                    isNewChat = true;
                    console.log('üî• Êñ∞ÂØπËØùÂ∑≤ÂàõÂª∫ÔºåID:', appState.currentChatId);
                } else {
                    console.log('üî• Â∑≤ÊúâÂΩìÂâçÂØπËØùÔºå‰∏çÂàõÂª∫Êñ∞ÂØπËØù');
                }

                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                const userMessage = {
                    id: utils.generateId(),
                    role: 'user',
                    content: text,
                    timestamp: new Date()
                };

                // Â¶ÇÊûúÊòØÊñ∞ÂàõÂª∫ÁöÑÂØπËØùÔºåÊõ¥Êñ∞ÁïåÈù¢Áä∂ÊÄÅ
                if (isNewChat) {
                    console.log('üî• ÂàõÂª∫Êñ∞ÂØπËØùÔºåÂºÄÂßãÁïåÈù¢ÂàáÊç¢');
                    sidebarManager.hideWelcomeScreen();
                    console.log('üî• ÈöêËóèÊ¨¢ËøéÁïåÈù¢ÂÆåÊàê');

                    sidebarManager.renderChatHistory();
                    console.log('üî• Ê∏≤ÊüìÂéÜÂè≤ÂàóË°®ÂÆåÊàê');

                    // ÂÖà‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞ÂØπËØùÂéÜÂè≤
                    this.saveMessage(userMessage);
                    console.log('üî• ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂÆåÊàêÔºåÂΩìÂâçÂØπËØùID:', appState.currentChatId);
                    console.log('üî• ÂØπËØùÂéÜÂè≤:', appState.chatHistory.find(c => c.id === appState.currentChatId));

                    // Áõ¥Êé•ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™ÂØπËØù
                    const chat = appState.chatHistory.find(c => c.id === appState.currentChatId);
                    if (chat && chat.messages.length > 0) {
                        console.log('üî• Áõ¥Êé•ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ');
                        // Âè™ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØÔºå‰∏çÊ∏ÖÁ©∫Êï¥‰∏™ÂÆπÂô®
                        this.addMessage(userMessage);
                    }

                    // ÁßªÈô§‰∫Ü"Êñ∞ÂØπËØùÂ∑≤ÂàõÂª∫"ÁöÑÊ∂àÊÅØÊèêÁ§∫

                    // Âú®Ê∂àÊÅØÊòæÁ§∫ÂÆåÊàêÂêéÔºåÊ∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂Á¶ÅÁî®ÊåâÈíÆ
                    this.messageInput.value = '';
                    this.autoResize();
                    this.sendBtn.disabled = true;
                    this.sendBtn.classList.add('loading');

                    // ÊòæÁ§∫AIÊ≠£Âú®ÊÄùËÄÉ
                    this.showThinkingIndicator();

                    // Ê®°ÊãüAIÂõûÂ§ç
                    setTimeout(() => {
                        this.removeThinkingIndicator();
                        this.generateAIResponse(text);
                    }, 1000 + Math.random() * 2000);
                } else {
                    // Â∑≤ÊúâÂØπËØùÔºåÁõ¥Êé•Ê∑ªÂä†Ê∂àÊÅØ
                    this.addMessage(userMessage);
                    this.saveMessage(userMessage);

                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    this.messageInput.value = '';
                    this.autoResize();

                    // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆ
                    this.sendBtn.disabled = true;
                    this.sendBtn.classList.add('loading');

                    // ÊòæÁ§∫AIÊ≠£Âú®ÊÄùËÄÉ
                    this.showThinkingIndicator();

                    // Ê®°ÊãüAIÂõûÂ§ç
                    setTimeout(() => {
                        this.removeThinkingIndicator();
                        this.generateAIResponse(text);
                    }, 1000 + Math.random() * 2000);
                }
            }

            generateChatTitle(firstMessage) {
                const title = firstMessage.length > 20 ?
                    firstMessage.substring(0, 20) + '...' :
                    firstMessage;
                return title;
            }

            showThinkingIndicator() {
                const thinkingMessage = {
                    id: 'thinking-' + Date.now(),
                    role: 'ai',
                    isThinking: true,
                    timestamp: new Date()
                };
                this.addMessage(thinkingMessage);
            }

            removeThinkingIndicator() {
                const thinkingMessage = this.messagesContainer.querySelector('[data-thinking="true"]');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
            }

            async generateAIResponse(userMessage) {
                // Ê®°ÊãüAIÂõûÂ§çÈÄªËæë
                const response = await this.mockAIResponse(userMessage);

                const aiMessage = {
                    id: utils.generateId(),
                    role: 'ai',
                    content: response.content,
                    processNodes: response.processNodes,
                    thinking: response.thinking,
                    timestamp: new Date()
                };

                this.addMessage(aiMessage);
                this.saveMessage(aiMessage);

                // ÊÅ¢Â§çÂèëÈÄÅÊåâÈíÆ
                this.sendBtn.disabled = false;
                this.sendBtn.classList.remove('loading');
            }

            async mockAIResponse(userMessage) {
                // ÁÆÄÂåñÁöÑAIÂõûÂ§çÂÜÖÂÆπ
                const responses = [
                    {
                        content: `# ‰∫ßÂìÅÂèÇÊï∞Êü•ËØ¢ÁªìÊûú

Ê†πÊçÆÊÇ®ÁöÑÊü•ËØ¢ÔºåÊàë‰∏∫ÊÇ®ÊâæÂà∞‰∫ÜÁõ∏ÂÖ≥‰∫ßÂìÅ‰ø°ÊÅØÔºö

## Áªü‰∏ÄÈíõÁ≤íÁéãT10ÂÖ®ÂêàÊàêÊü¥Ê≤πÊú∫Ê≤π

üéØ **Ê†∏ÂøÉÂèÇÊï∞**Ôºö
- **APIÁ≠âÁ∫ß**ÔºöCK-4
- **SAEÁ≤òÂ∫¶**Ôºö10W-40 / 5W-30
- **Âü∫Á°ÄÊ≤πÁ±ªÂûã**ÔºöÂÖ®ÂêàÊàê
- **ËøêÂä®Á≤òÂ∫¶@100‚ÑÉ**Ôºö11.75 mm¬≤/s
- **Èó™ÁÇπ**Ôºö228‚ÑÉ
- **ÂÄæÁÇπ**Ôºö-45‚ÑÉ

‚úÖ **‰∫ßÂìÅ‰ºòÂäø**Ôºö
- Ê¥ªÂ°ûÈ°∂ÈÉ®ÈáçÁßØÁ¢≥‰∏∫0
- ÁáÉÊ≤πÁªèÊµéÊÄßËææ1.2%
- ÂÆûÈôÖÈÅìË∑ØÊµãËØïË∂ÖËøá12‰∏áÂÖ¨Èáå
- ‰ºòÂºÇÁöÑÊäóÁ£®ÊçüÊÄßËÉΩ

üì¶ **ÂåÖË£ÖËßÑÊ†º**Ôºö
- 4LË£Ö (4L√ó4)
- 18LË£Ö (18L√ó1)
- 170kgË£Ö

Â¶ÇÈúÄÊõ¥ËØ¶ÁªÜÁöÑÊäÄÊúØÂèÇÊï∞ÔºåËØ∑ÂëäËØâÊàëÂÖ∑‰ΩìÈúÄË¶ÅÂì™È°πÊï∞ÊçÆ„ÄÇ

---

## ÂèÇËÄÉËµÑÊñô
- [Áü•ËØÜÂõæË∞±] Áªü‰∏ÄÈíõÁ≤íÁéãT10‰∫ßÂìÅ‰ø°ÊÅØ
- [ÊñáÊ°£] ‰∫ßÂìÅËµÑÊñôÊñáÊ°£`,
                        processNodes: [
                            { name: 'ÁêÜËß£Áî®Êà∑Êü•ËØ¢', status: 'completed' },
                            { name: 'Ê£ÄÁ¥¢‰∫ßÂìÅÊï∞ÊçÆÂ∫ì', status: 'completed' },
                            { name: 'ÊèêÂèñÊäÄÊúØÂèÇÊï∞', status: 'completed' },
                            { name: 'ÁîüÊàêÂõûÂ§çÂÜÖÂÆπ', status: 'completed' }
                        ],
                        thinking: appState.deepThinkingEnabled ?
                            'Áî®Êà∑ËØ¢ÈóÆ‰∫ßÂìÅÂèÇÊï∞ÔºåÊàëÈúÄË¶ÅÊèê‰æõÂÆåÊï¥ÁöÑÊäÄÊúØËßÑÊ†º‰ø°ÊÅØÔºåÂåÖÊã¨APIÁ≠âÁ∫ß„ÄÅÁ≤òÂ∫¶„ÄÅÂü∫Á°ÄÊ≤πÁ±ªÂûãÁ≠âÂÖ≥ÈîÆÂèÇÊï∞„ÄÇ' : null
                    },
                    {
                        content: `# ÁüøÂ±±Ë°å‰∏öÊ∂¶ÊªëËß£ÂÜ≥ÊñπÊ°à

üè≠ **Ë°å‰∏öÁâπÁÇπÂàÜÊûê**Ôºö
Èú≤Â§©Áüø‰∏öÂ∑•ÂÜµÁâπÁÇπÔºöÊûÅÁ´ØÈ´ò‰ΩéÊ∏©„ÄÅ‰ΩéÈÄüÈáçËΩΩ„ÄÅÈ´òÁ≤âÂ∞òÁéØÂ¢ÉÔºåÂØπÊ∂¶ÊªëÊ≤πÂìÅÊèêÂá∫‰∏•Â≥ªÊåëÊàò„ÄÇ

üîß **Êé®ËçêÊñπÊ°à**Ôºö

**ÈáçÂûãËÆæÂ§áÔºà220Âê®Á∫ßÁüøÂç°Ôºâ**Ôºö
- **Êé®Ëçê‰∫ßÂìÅ**ÔºöÁªü‰∏ÄÈíõÁ≤íÁéãT10ÂÖ®ÂêàÊàêÊü¥Ê≤πÊú∫Ê≤πCK-4 10W-40
- **Ê†∏ÂøÉ‰ºòÂäø**ÔºöÊç¢Ê≤πÂë®ÊúüÂª∂ÈïøËá≥400Â∞èÊó∂
- **ÁªèÊµéÊïàÁõä**ÔºöÂπ¥ËäÇÁ∫¶ÊàêÊú¨50‰∏áÂÖÉ

**ÁîµÈì≤ËÆæÂ§á**Ôºö
- **Êé®Ëçê‰∫ßÂìÅ**ÔºöÁªü‰∏ÄÈΩøËΩÆÊ≤π75W-90
- **Ê†∏ÂøÉ‰ºòÂäø**ÔºöÊûÅÁ´Ø‰ΩéÊ∏©Â∑•ÂÜµÁ®≥ÂÆöÂ∫îÁî®
- **ÊäÄÊúØÁâπÁÇπ**Ôºö‰ºòÂºÇÁöÑ‰ΩéÊ∏©ÊµÅÂä®ÊÄß

**ÊåñÊéòËÆæÂ§á**Ôºö
- **Êé®Ëçê‰∫ßÂìÅ**ÔºöÁªü‰∏ÄÊ∂≤ÂéãÊ≤π
- **Ê†∏ÂøÉ‰ºòÂäø**ÔºöÊäóÁ£®ÊçüÊÄßËÉΩ‰ºòÂºÇ
- **ÈÄÇÁî®ËåÉÂõ¥**ÔºöÂêÑÁ±ªÊ∂≤ÂéãÁ≥ªÁªü

‚ö° **ÁªºÂêà‰ºòÂäø**Ôºö
- ÊõøÊç¢ËøõÂè£ÂìÅÁâåÔºåÂ§ßÂπÖÈôç‰Ωé‰ΩøÁî®ÊàêÊú¨
- ÊûÅÁ´ØÂ∑•ÂÜµ‰∏ãÁ®≥ÂÆöÊÄßËÉΩ‰øùÈöú
- ‰∏ì‰∏öÊäÄÊúØÊúçÂä°ÊîØÊåÅ

üí° **ÂÆûÊñΩÂª∫ËÆÆ**Ôºö
Âª∫ËÆÆÂª∫Á´ãËÆæÂ§á‰øùÂÖªÂè∞Ë¥¶ÔºåÂÆöÊúüÁõëÊµãÊ≤πÂìÅÁä∂ÊÄÅÔºåÁ°Æ‰øùËÆæÂ§áÁ®≥ÂÆöËøêË°å„ÄÇ

---

## ÂèÇËÄÉËµÑÊñô
- [ÊñáÊ°£] ÁüøÂ±±Ë°å‰∏öËß£ÂÜ≥ÊñπÊ°à
- [Áü•ËØÜÂõæË∞±] Â∑•Á®ãËÆæÂ§áÊ∂¶ÊªëÊñπÊ°à`,
                        processNodes: [
                            { name: 'ËØÜÂà´Ë°å‰∏öÂú∫ÊôØ', status: 'completed' },
                            { name: 'ÂàÜÊûêÂ∑•ÂÜµÁâπÁÇπ', status: 'completed' },
                            { name: 'ÂåπÈÖç‰∫ßÂìÅÊñπÊ°à', status: 'completed' },
                            { name: 'ÁîüÊàêÊé®ËçêÊä•Âëä', status: 'completed' }
                        ],
                        thinking: appState.deepThinkingEnabled ?
                            'Áî®Êà∑ËØ¢ÈóÆÁüøÂ±±Ë°å‰∏öËß£ÂÜ≥ÊñπÊ°àÔºåÊàëÈúÄË¶ÅÊ†πÊçÆ‰∏çÂêåËÆæÂ§áÁ±ªÂûãÊèê‰æõÈíàÂØπÊÄßÁöÑÊ∂¶Êªë‰∫ßÂìÅÊé®ËçêÂíåÊñπÊ°àÂª∫ËÆÆ„ÄÇ' : null
                    }
                ];

                return responses[Math.floor(Math.random() * responses.length)];
            }

            addMessage(message, skipAnimation = false) {
                console.log('üî• addMessage ÂºÄÂßãÊâßË°åÔºåÊ∂àÊÅØ:', message, 'Ë∑≥ËøáÂä®Áîª:', skipAnimation);
                const messageEl = this.createMessageElement(message);
                console.log('üî• Ê∂àÊÅØÂÖÉÁ¥†ÂàõÂª∫ÂÆåÊàê:', messageEl);
                console.log('üî• messagesContainer:', this.messagesContainer);

                // Ê£ÄÊü•Ê∂àÊÅØÂÆπÂô®ÁöÑÂèØËßÅÊÄß
                console.log('üî• messagesContainer display:', window.getComputedStyle(this.messagesContainer).display);
                console.log('üî• messagesContainer visibility:', window.getComputedStyle(this.messagesContainer).visibility);
                console.log('üî• messagesContainer opacity:', window.getComputedStyle(this.messagesContainer).opacity);
                console.log('üî• messagesContainer height:', window.getComputedStyle(this.messagesContainer).height);

                this.messagesContainer.appendChild(messageEl);
                console.log('üî• Ê∂àÊÅØÂÖÉÁ¥†Â∑≤Ê∑ªÂä†Âà∞ÂÆπÂô®');
                console.log('üî• ÂÆπÂô®Â≠êÂÖÉÁ¥†Êï∞Èáè:', this.messagesContainer.children.length);

                this.scrollToBottom();

                // Âè™ÊúâÂú®‰∏çÊòØÂéÜÂè≤Ê∂àÊÅØÊ∏≤ÊüìÊó∂Êâç‰ΩøÁî®ÊâìÂ≠óÊú∫ÊïàÊûú
                if (message.role === 'ai' && !message.isThinking && !skipAnimation) {
                    console.log('üî• ÂºÄÂßãAIÊ∂àÊÅØÊâìÂ≠óÊú∫Âä®Áîª');
                    this.animateAIMessage(messageEl, message);
                } else if (message.role === 'ai' && skipAnimation) {
                    console.log('üî• Ë∑≥ËøáAIÊ∂àÊÅØÂä®ÁîªÔºåÁõ¥Êé•ÊòæÁ§∫ÂØåÊñáÊú¨ÂÜÖÂÆπ');
                    // Áõ¥Êé•ËÆæÁΩÆÂÜÖÂÆπÔºå‰∏ç‰ΩøÁî®ÊâìÂ≠óÊú∫ÊïàÊûú
                    const responseTextEl = messageEl.querySelector(`#response-text-${message.id}`);
                    if (responseTextEl && message.content) {
                        const parsedContent = utils.parseMarkdown(message.content);
                        responseTextEl.innerHTML = parsedContent;
                        console.log('üî• Áõ¥Êé•ËÆæÁΩÆAIÊ∂àÊÅØÂØåÊñáÊú¨ÂÜÖÂÆπ:', parsedContent);
                    }
                }
            }

            createMessageElement(message) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.role}`;
                messageEl.dataset.messageId = message.id;

                if (message.isThinking) {
                    messageEl.dataset.thinking = 'true';
                }

                const avatar = this.createAvatar(message.role);
                const content = this.createMessageContent(message);

                messageEl.appendChild(avatar);
                messageEl.appendChild(content);

                return messageEl;
            }

            createAvatar(role) {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';

                if (role === 'user') {
                    avatar.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    `;
                } else {
                    avatar.innerHTML = `
                        <img src="assets/images/logo.png" alt="AI‰∫ßÂìÅ‰∏ìÂÆ∂">
                    `;
                }

                return avatar;
            }

            createMessageContent(message) {
                const content = document.createElement('div');
                content.className = 'message-content';

                if (message.isThinking) {
                    content.innerHTML = `
                        <div class="message-bubble">
                            <div class="thinking-indicator">
                                <span>ÂÆâÂÆâÊ≠£Âú®ÊÄùËÄÉ‰∏≠</span>
                                <div class="thinking-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (message.role === 'ai') {
                    content.innerHTML = this.createAIMessageHTML(message);
                } else {
                    content.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">${utils.escapeHtml(message.content)}</div>
                            <button class="copy-btn" onclick="chatManager.copyMessage('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }

                return content;
            }

            createAIMessageHTML(message) {
                let html = '<div class="ai-message">';

                // ÊµÅÁ®ãËäÇÁÇπ
                if (message.processNodes && message.processNodes.length > 0) {
                    html += `
                        <div class="process-nodes" id="process-nodes-${message.id}">
                            <div class="process-nodes-header" onclick="chatManager.toggleProcessNodes('${message.id}')">
                                <h4>Â§ÑÁêÜÊµÅÁ®ã</h4>
                                <svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </div>
                            <div class="process-nodes-content">
                    `;

                    message.processNodes.forEach(node => {
                        const statusClass = node.status;
                        const statusIcon = node.status === 'completed' ? '‚úì' :
                                         node.status === 'processing' ? '‚ü≥' :
                                         node.status === 'error' ? '‚úï' : '‚óã';

                        html += `
                            <div class="process-node">
                                <div class="node-status ${statusClass}">${statusIcon}</div>
                                <div class="node-name">${node.name}</div>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                }

                // ÊÄùËÄÉËøáÁ®ã
                if (message.thinking && appState.deepThinkingEnabled) {
                    html += `
                        <div class="thinking-section" id="thinking-${message.id}">
                            <div class="thinking-header" onclick="chatManager.toggleThinking('${message.id}')">
                                <h4>ÊÄùËÄÉËøáÁ®ã</h4>
                                <svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </div>
                            <div class="thinking-content">
                                <div class="thinking-text">${message.thinking}</div>
                            </div>
                        </div>
                    `;
                }

                // ÂõûÂ§çÂÜÖÂÆπ
                html += `
                    <div class="message-body">
                        <div class="response-text" id="response-text-${message.id}"></div>
                        <div class="message-actions">
                            <button class="action-btn" onclick="chatManager.copyMessage('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                                Â§çÂà∂Ê∂àÊÅØ
                            </button>
                            <button class="action-btn" onclick="chatManager.exportHTML('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                ÁîüÊàêHTML
                            </button>
                            <button class="action-btn" onclick="chatManager.exportPDF('${message.id}')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L10,15L13,15L17,10"/>
                                </svg>
                                ÂØºÂá∫PDF
                            </button>
                        </div>
                    </div>
                `;

                html += '</div>';
                return html;
            }

            animateAIMessage(messageEl, message) {
                const responseTextEl = messageEl.querySelector(`#response-text-${message.id}`);
                if (responseTextEl && message.content) {
                    console.log('üî• ÂºÄÂßãÂØåÊñáÊú¨ÊâìÂ≠óÊú∫ÊïàÊûúÔºåÂéüÂßãMarkdown:', message.content);
                    this.currentTypingEffect = new RichTextTypingEffect(responseTextEl, message.content, 10);
                    this.currentTypingEffect.start();
                }
            }

            toggleProcessNodes(messageId) {
                const nodesEl = document.getElementById(`process-nodes-${messageId}`);
                if (nodesEl) {
                    nodesEl.classList.toggle('expanded');
                }
            }

            toggleThinking(messageId) {
                const thinkingEl = document.getElementById(`thinking-${messageId}`);
                if (thinkingEl) {
                    thinkingEl.classList.toggle('expanded');
                }
            }

            copyMessage(messageId) {
                const message = appState.chatHistory
                    .find(chat => chat.messages.some(msg => msg.id === messageId))
                    ?.messages.find(msg => msg.id === messageId);

                if (message) {
                    utils.copyToClipboard(message.content);
                }
            }

            exportHTML(messageId) {
                const message = appState.chatHistory
                    .find(chat => chat.messages.some(msg => msg.id === messageId))
                    ?.messages.find(msg => msg.id === messageId);

                if (message) {
                    this.downloadHTML(message.content, `ai-response-${messageId}.html`);
                }
            }

            downloadHTML(content, filename) {
                const html = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI‰∫ßÂìÅ‰∏ìÂÆ∂ÂõûÂ§ç</title>
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #4d6bfe; border-bottom: 2px solid #4d6bfe; padding-bottom: 10px; }
        h2 { color: #1f2937; margin-top: 30px; }
        h3 { color: #1f2937; }
        ul, li { margin: 10px 0; }
        strong { color: #4d6bfe; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
        .section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }
    </style>
</head>
<body>
    <div style="text-align: center; margin-bottom: 30px;">
        <h1>AI‰∫ßÂìÅ‰∏ìÂÆ∂ÂõûÂ§ç</h1>
        <p style="color: #666;">ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}</p>
    </div>
    <div class="content">
        ${content.replace(/#{1,6}\s+/g, '<h2>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
    </div>
    <hr style="margin: 40px 0;">
    <p style="text-align: center; color: #999; font-size: 14px;">
        Áî±AI‰∫ßÂìÅ‰∏ìÂÆ∂ÂÆâÂÆâÁîüÊàê | Áªü‰∏ÄÊ∂¶ÊªëÊ≤πÂÖ¨Âè∏
    </p>
</body>
</html>`;

                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                utils.showToast('HTMLÊñá‰ª∂Â∑≤ÁîüÊàê', 'success');
            }

            exportPDF(messageId) {
                const message = appState.chatHistory
                    .find(chat => chat.messages.some(msg => msg.id === messageId))
                    ?.messages.find(msg => msg.id === messageId);

                if (message) {
                    this.printToPDF(message.content, messageId);
                }
            }

            printToPDF(content, messageId) {
                try {
                    // Âä®ÊÄÅÂä†ËΩΩjsPDFÂ∫ì
                    if (typeof window.jspdf === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
                        script.onload = () => this.generatePDF(content, messageId);
                        script.onerror = () => {
                            console.error('jsPDFÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                            this.fallbackPDF(content);
                        };
                        document.head.appendChild(script);
                    } else {
                        this.generatePDF(content, messageId);
                    }
                } catch (error) {
                    console.error('ÁîüÊàêPDFÂ§±Ë¥•:', error);
                    utils.showToast('ÁîüÊàêPDFÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }
            }

            generatePDF(content, messageId) {
                try {
                    const { jsPDF } = window.jspdf;

                    // ÂàõÂª∫PDFÊñáÊ°£Ôºå‰ΩøÁî®A4Á∫∏Âº†
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // ‰ΩøÁî®Ëã±ÊñáÊ®°ÊùøÊ∂àÊÅØÔºàÈÅøÂÖç‰∏≠ÊñáÁºñÁ†ÅÈóÆÈ¢òÔºâ
                    const templateContent = `# AI Product Expert Recommendation

## Product Analysis
Based on your requirements, I recommend the following lubrication solutions:

### **Premium Engine Oil Series**
- **Product Code**: UEO-2025-XP
- **Viscosity**: 5W-30
- **Specifications**: API SP, ILSAC GF-6
- **Benefits**:
  - Superior engine protection
  - Enhanced fuel economy
  - Extended drain intervals
  - Excellent thermal stability

### **Industrial Gear Oil**
- **Product Code**: IGO-2025-HD
- **Viscosity Range**: ISO VG 220-460
- **Applications**:
  - Heavy-duty gearboxes
  - Industrial machinery
  - Mining equipment
  - Wind turbines

## Technical Specifications

### Performance Characteristics
| Parameter | Value | Unit |
|-----------|-------|------|
| Kinematic Viscosity @40¬∞C | 89.2 | mm¬≤/s |
| Kinematic Viscosity @100¬∞C | 14.1 | mm¬≤/s |
| Viscosity Index | 171 | - |
| Flash Point | 210 | ¬∞C |
| Pour Point | -42 | ¬∞C |

### Compatibility
- Compatible with most synthetic and mineral oils
- Suitable for gasoline and diesel engines
- Meets OEM requirements for major manufacturers

## Usage Recommendations

### Application Instructions
1. **Preparation**: Ensure equipment is clean and dry
2. **Application**: Follow manufacturer's recommended fill levels
3. **Monitoring**: Check oil quality periodically
4. **Replacement**: Change oil according to service schedule

### Storage Guidelines
- Store in original containers
- Keep away from direct sunlight
- Temperature range: -20¬∞C to 50¬∞C
- Shelf life: 5 years from production date

## Quality Assurance

Our products undergo rigorous testing:
- Laboratory analysis
- Field performance validation
- Quality certification
- Environmental compliance testing

## Contact Information
For technical support and inquiries:
- **Phone**: +86-400-888-9999
- **Email**: expert@unified-lubricants.com
- **Website**: www.unified-lubricants.com

---
*This recommendation is generated by AI Product Expert System based on your specific requirements and industry best practices.*`;

                    // PDFÈ°µÈù¢ËÆæÁΩÆ
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 20;
                    const lineHeight = 6;
                    const maxLineWidth = pageWidth - 2 * margin;
                    let currentY = margin;

                    // Ê∑ªÂä†Ê†áÈ¢ò
                    pdf.setFontSize(20);
                    pdf.setTextColor(77, 107, 254);
                    pdf.text('AI Product Expert Report', margin, currentY);
                    currentY += 15;

                    // Ê∑ªÂä†Êó∂Èó¥Êà≥
                    pdf.setFontSize(10);
                    pdf.setTextColor(153, 153, 153);
                    const timestamp = new Date().toLocaleString('en-US');
                    pdf.text(`Generated: ${timestamp}`, margin, currentY);
                    currentY += 10;

                    // Ê∑ªÂä†ÂàÜÂâ≤Á∫ø
                    pdf.setDrawColor(221, 221, 221);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 10;

                    // Â§ÑÁêÜÊ®°ÊùøÂÜÖÂÆπÔºåËá™Âä®Êç¢Ë°å
                    pdf.setFontSize(12);
                    pdf.setTextColor(51, 51, 51);

                    const lines = pdf.splitTextToSize(templateContent, maxLineWidth);

                    lines.forEach(line => {
                        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊñ∞È°µÈù¢
                        if (currentY + lineHeight > pageHeight - margin) {
                            pdf.addPage();
                            currentY = margin;
                        }

                        pdf.text(line, margin, currentY);
                        currentY += lineHeight;
                    });

                    // Ê∑ªÂä†È°µËÑö
                    const footerY = pageHeight - 15;
                    pdf.setFontSize(10);
                    pdf.setTextColor(153, 153, 153);
                    pdf.text('Generated by AI Product Expert | Unified Lubricants Co., Ltd.', margin, footerY);

                    // ÁîüÊàêÊñá‰ª∂Âêç
                    const timestamp2 = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    const filename = `AI_Product_Expert_Report_${timestamp2}.pdf`;

                    // ‰øùÂ≠òPDF
                    pdf.save(filename);

                    utils.showToast('PDF report successfully generated and downloaded', 'success');

                } catch (error) {
                    console.error('PDF generation failed:', error);
                    utils.showToast('PDF generation failed, trying fallback...', 'warning');
                    this.fallbackPDF(content);
                }
            }

            fallbackPDF(content) {
                try {
                    // Â§áÁî®ÊñπÊ°àÔºöÁîüÊàêÁ∫ØÊñáÊú¨Êñá‰ª∂
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = utils.parseMarkdown(content);
                    const textContent = tempDiv.textContent || content;

                    const fileContent = `AI Product Expert Reply
========================

Generated: ${new Date().toLocaleString('zh-CN')}

${textContent}

---
Generated by AI Product Expert An An | Unified Lubricants Co., Ltd.
`;

                    const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    a.download = `AI_Reply_${timestamp}.txt`;

                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    utils.showToast('Â∑≤ÁîüÊàêÊñáÊú¨Êñá‰ª∂ÔºåËØ∑Â§çÂà∂ÂÜÖÂÆπÂà∞Word‰∏≠Âè¶Â≠ò‰∏∫PDF', 'success');

                } catch (error) {
                    console.error('Â§áÁî®ÊñπÊ°à‰πüÂ§±Ë¥•‰∫Ü:', error);
                    utils.showToast('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }
            }

            saveMessage(message) {
                const currentChat = appState.chatHistory.find(chat => chat.id === appState.currentChatId);
                if (currentChat) {
                    currentChat.messages.push(message);
                    appState.saveState();
                }
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        }

        // Ê¨¢ËøéÈ°µÈù¢ÁÆ°ÁêÜ
        class WelcomeManager {
            constructor() {
                this.welcomeText = document.getElementById('welcome-text');
                this.welcomeMessages = [
                    `ÊÇ®Â•ΩÔºå${appState.userName}ÔºÅÊàëÊòØÊÇ®ÁöÑAI‰∫ßÂìÅ‰∏ìÂÆ∂ÂÆâÂÆâÔºå‰ªäÂ§©ÈúÄË¶ÅÊü•ËØ¢‰∫ßÂìÅËøòÊòØÁîüÊàêÊñπÊ°àÔºü`,
                    `‰Ω†Â•ΩÔºå${appState.userName}ÔºÅÊàëÊòØÂÆâÂÆâÔºåÊúâ‰ªÄ‰πàÊ∂¶Êªë‰∫ßÂìÅÁõ∏ÂÖ≥ÈóÆÈ¢òÊàëÂèØ‰ª•Â∏ÆÊÇ®Ëß£Á≠îÂêóÔºü`,
                    `${appState.userName}ÔºåÊ¨¢ËøéÂõûÊù•ÔºÅÊàëÊòØÂÆâÂÆâÔºåÊÇ®ÁöÑ‰∏ìÂ±ûÊ∂¶Êªë‰∫ßÂìÅ‰∏ìÂÆ∂„ÄÇ`
                ];
                this.currentMessageIndex = 0;
                this.typingEffect = null;
                this.init();
            }

            init() {
                // Âª∂ËøüÂàùÂßãÂåñÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
                setTimeout(() => {
                    const welcomeScreen = document.getElementById('welcome-screen');
                    const inputArea = document.querySelector('.input-area');

                    console.log('üî• WelcomeManager Âª∂Ëøüinit ÂºÄÂßã');
                    console.log('üî• welcomeScreen:', welcomeScreen);
                    console.log('üî• inputArea:', inputArea);

                    if (welcomeScreen) {
                        welcomeScreen.classList.add('active');
                        console.log('üî• Ê¨¢ËøéÁïåÈù¢Â∑≤Ê∑ªÂä†activeÁ±ª');
                    }

                    // ÂÜçÊ¨°Âª∂ËøüËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆÔºåÁ°Æ‰øùÊ†∑ÂºèÂÆåÂÖ®ÁîüÊïà
                    setTimeout(() => {
                        if (inputArea) {
                            console.log('üî• WelcomeManager ÂºÄÂßãËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆ');

                            // ÂÖàÂº∫Âà∂Ê∏ÖÈô§ÊâÄÊúâÂèØËÉΩÁöÑÊ†∑Âºè
                            inputArea.style.cssText = '';

                            // ÈáçÊñ∞ËÆæÁΩÆÊàë‰ª¨ÊÉ≥Ë¶ÅÁöÑÊ†∑Âºè
                            inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ‰∏ãË∞É50pxÔºåË∞ÉÊï¥‰∏∫-250px */
                            inputArea.style.setProperty('background-color', 'transparent', 'important');
                            inputArea.style.setProperty('padding-top', '0', 'important');
                            inputArea.style.setProperty('padding-bottom', '0', 'important');
                            inputArea.style.setProperty('margin-bottom', '0', 'important');

                            console.log('üî• WelcomeManager ËæìÂÖ•Ê°Ü‰ΩçÁΩÆËÆæÁΩÆÂÆåÊàê');
                            console.log('üî• ËÆæÁΩÆÂêéÁöÑÊ†∑Âºè:', inputArea.style.cssText);

                            // È¢ùÂ§ñÊ£ÄÊü•ÔºöÂÜçÊ¨°Á°ÆËÆ§Ê†∑ÂºèÊòØÂê¶ËÆæÁΩÆÊàêÂäü
                            setTimeout(() => {
                                const computedStyle = window.getComputedStyle(inputArea);
                                console.log('üî• ËÆ°ÁÆóÂêéÁöÑmarginTop:', computedStyle.marginTop);
                                console.log('üî• ËÆ°ÁÆóÂêéÁöÑbackgroundColor:', computedStyle.backgroundColor);
                            }, 50);
                        } else {
                            console.error('üî• Êâæ‰∏çÂà∞inputAreaÂÖÉÁ¥†ÔºÅ');
                        }
                    }, 200);
                }, 300); // Â¢ûÂä†Âª∂ËøüÊó∂Èó¥Á°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ

                this.startWelcomeAnimation();
                this.bindTaskCards();
            }

            startWelcomeAnimation() {
                this.showWelcomeMessage();
            }

            showWelcomeMessage() {
                const message = this.welcomeMessages[this.currentMessageIndex];
                this.typingEffect = new TypingEffect(this.welcomeText, message, 120);
                this.typingEffect.onComplete = () => {
                    setTimeout(() => {
                        this.currentMessageIndex = (this.currentMessageIndex + 1) % this.welcomeMessages.length;
                        this.showWelcomeMessage();
                    }, 5000);
                };
                this.typingEffect.start();
            }

            bindTaskCards() {
                const taskCards = document.querySelectorAll('.task-card');
                taskCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const taskType = card.dataset.task;
                        this.handleTaskCardClick(taskType);
                    });
                });
            }

            handleTaskCardClick(taskType) {
                switch (taskType) {
                    case 'product-query':
                        modalManager.show(this.createProductQueryModal());
                        break;
                    case 'competitor-comparison':
                        modalManager.show(this.createCompetitorComparisonModal());
                        break;
                    case 'scenario-solution':
                        modalManager.show(this.createScenarioSolutionModal());
                        break;
                }
            }

            createProductQueryModal() {
                return `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">‰∫ßÂìÅÂèÇÊï∞ÈÄüÊü•</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">‰∫ßÂìÅÂêçÁß∞/Áâ©ÊñôÂè∑/Áâ©ÊñôÊèèËø∞</label>
                                <input type="text" class="form-input" id="product-name" placeholder="‰æãÂ¶ÇÔºöÁªü‰∏ÄÈíõÁ≤íÁéãT10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂèÇÊï∞ÂêçÁß∞</label>
                                <select class="form-select" id="parameter-type">
                                    <option value="all">ÂÖ®ÈÉ®ÂèÇÊï∞</option>
                                    <option value="viscosity">ËøêÂä®Á≤òÂ∫¶</option>
                                    <option value="flash-point">Èó™ÁÇπ</option>
                                    <option value="pour-point">ÂÄæÁÇπ</option>
                                    <option value="api-level">APIÁ≠âÁ∫ß</option>
                                </select>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="deep-thinking-query">
                                <label for="deep-thinking-query">ÂºÄÂêØÊ∑±Â∫¶ÊÄùËÄÉ</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">ÂèñÊ∂à</button>
                            <button class="btn btn-primary" onclick="welcomeManager.sendProductQuery()">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                `;
            }

            createCompetitorComparisonModal() {
                return `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">ÁîüÊàêÁ´ûÂìÅÂØπÊØîË°®</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">‰∫ßÂìÅÂêçÁß∞</label>
                                <input type="text" class="form-input" id="product-1" placeholder="‰æãÂ¶ÇÔºöÁªü‰∏ÄÈíõÁ≤íÁéãT10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊØî‰∫ßÂìÅÂêçÁß∞</label>
                                <input type="text" class="form-input" id="product-2" placeholder="‰æãÂ¶ÇÔºöÂ£≥ÁâåÂä≤Èú∏K10">
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="deep-thinking-comparison">
                                <label for="deep-thinking-comparison">ÂºÄÂêØÊ∑±Â∫¶ÊÄùËÄÉ</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">ÂèñÊ∂à</button>
                            <button class="btn btn-primary" onclick="welcomeManager.sendComparison()">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                `;
            }

            createScenarioSolutionModal() {
                return `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">ÂàõÂª∫Âú∫ÊôØÊñπÊ°à</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Ë°å‰∏ö/Âú∫ÊôØ</label>
                                <select class="form-select" id="industry-type">
                                    <option value="">ËØ∑ÈÄâÊã©Ë°å‰∏ö</option>
                                    <option value="mining">ÁüøÂ±±</option>
                                    <option value="logistics">Áâ©ÊµÅ</option>
                                    <option value="construction">Âª∫Á≠ë</option>
                                    <option value="manufacturing">Âà∂ÈÄ†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ËÆæÂ§á/ÂûãÂè∑/Ê∂¶ÊªëÈÉ®‰ΩçÂèäÂ∑•ÂÜµ/ÊéíÊîæ‰ø°ÊÅØ</label>
                                <textarea class="form-textarea" id="equipment-info" placeholder="‰æãÂ¶ÇÔºöÂ∞èÊùæPC850ÊåñÊéòÊú∫ÔºåÈáçËΩΩÂ∑•ÂÜµÔºåÂõΩÂÖ≠ÊéíÊîæ Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°å"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊúüÊúõËææÊàêÁöÑÁõÆÊ†á</label>
                                <textarea class="form-textarea" id="expected-goals" placeholder="‰æãÂ¶ÇÔºöÂª∂ÈïøÊç¢Ê≤πÂë®ÊúüÔºåÈôç‰ΩéÁª¥Êä§ÊàêÊú¨ Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°å"></textarea>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="deep-thinking-solution" checked>
                                <label for="deep-thinking-solution">ÂºÄÂêØÊ∑±Â∫¶ÊÄùËÄÉ</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">ÂèñÊ∂à</button>
                            <button class="btn btn-primary" onclick="welcomeManager.sendSolution()">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                `;
            }

            sendProductQuery() {
                const productName = document.getElementById('product-name').value;
                const parameterType = document.getElementById('parameter-type').value;
                const deepThinking = document.getElementById('deep-thinking-query').checked;

                if (!productName.trim()) {
                    utils.showToast('ËØ∑ËæìÂÖ•‰∫ßÂìÅÂêçÁß∞', 'error');
                    return;
                }

                const message = `Êü•ËØ¢${productName}ÁöÑ${parameterType === 'all' ? 'ÂÖ®ÈÉ®ÂèÇÊï∞' : parameterType}`;

                appState.deepThinkingEnabled = deepThinking;
                chatManager.messageInput.value = message;
                modalManager.close();
                chatManager.sendMessage();
            }

            sendComparison() {
                const product1 = document.getElementById('product-1').value;
                const product2 = document.getElementById('product-2').value;
                const deepThinking = document.getElementById('deep-thinking-comparison').checked;

                if (!product1.trim() || !product2.trim()) {
                    utils.showToast('ËØ∑ËæìÂÖ•Ë¶ÅÂØπÊØîÁöÑ‰∫ßÂìÅÂêçÁß∞', 'error');
                    return;
                }

                const message = `ÂØπÊØî${product1}Âíå${product2}ÁöÑÊÄßËÉΩÂèÇÊï∞ÂíåÁâπÁÇπ`;

                appState.deepThinkingEnabled = deepThinking;
                chatManager.messageInput.value = message;
                modalManager.close();
                chatManager.sendMessage();
            }

            sendSolution() {
                const industryType = document.getElementById('industry-type').value;
                const equipmentInfo = document.getElementById('equipment-info').value;
                const expectedGoals = document.getElementById('expected-goals').value;
                const deepThinking = document.getElementById('deep-thinking-solution').checked;

                if (!industryType || !equipmentInfo.trim()) {
                    utils.showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑË°å‰∏öÂíåËÆæÂ§á‰ø°ÊÅØ', 'error');
                    return;
                }

                const message = `‰∏∫${industryType}Ë°å‰∏öÁöÑ${equipmentInfo}Êèê‰æõÊ∂¶ÊªëÊñπÊ°àÔºåÁõÆÊ†áÔºö${expectedGoals || '‰ºòÂåñÊ∂¶ÊªëÊïàÊûú'}`;

                appState.deepThinkingEnabled = deepThinking;
                chatManager.messageInput.value = message;
                modalManager.close();
                chatManager.sendMessage();
            }
        }

        // ‰æßËæπÊ†èÁÆ°ÁêÜ
        class SidebarManager {
            constructor() {
                this.sidebar = document.getElementById('sidebar');
                this.historyList = document.getElementById('history-list');
                this.init();
            }

            init() {
                this.bindToggle();
                this.bindTopNewChat();
                this.bindNewChat();
                this.bindUserMenu();
                this.bindBrandClick();
                this.loadChatHistory();
            }

            bindToggle() {
                const toggleBtn = document.getElementById('sidebar-toggle');
                toggleBtn.addEventListener('click', () => {
                    this.toggle();
                });
            }

            bindTopNewChat() {
                const combinedActionBtn = document.getElementById('combined-action-btn');
                console.log('üî• bindTopNewChat - ÊâæÂà∞ÁªÑÂêàÊåâÈíÆ:', combinedActionBtn);

                combinedActionBtn.addEventListener('click', (e) => {
                    console.log('üî• ÁªÑÂêàÊåâÈíÆË¢´ÁÇπÂáª');
                    // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂì™‰∏™ÈÉ®ÂàÜ
                    const expandIcon = e.target.closest('.expand-icon');
                    const newChatIcon = e.target.closest('.new-chat-icon');

                    console.log('üî• expandIcon:', expandIcon);
                    console.log('üî• newChatIcon:', newChatIcon);
                    console.log('üî• e.target:', e.target);

                    if (expandIcon) {
                        // ÁÇπÂáªÂ±ïÂºÄÂõæÊ†á - Â±ïÂºÄ‰æßËæπÊ†è
                        console.log('üî• ÁÇπÂáª‰∫ÜÂ±ïÂºÄÂõæÊ†á');
                        this.expand();
                    } else if (newChatIcon) {
                        // ÁÇπÂáªÊñ∞Âª∫ÂØπËØùÂõæÊ†á - ÂàõÂª∫Êñ∞ÂØπËØù
                        console.log('üî• ÁÇπÂáª‰∫ÜÊñ∞Âª∫ÂØπËØùÂõæÊ†á');
                        this.createNewChat();
                    } else if (e.target === combinedActionBtn) {
                        // ÁÇπÂáªÊåâÈíÆÂÖ∂‰ªñÂå∫Âüü - ÈªòËÆ§‰∏∫Êñ∞Âª∫ÂØπËØù
                        console.log('üî• ÁÇπÂáª‰∫ÜÊåâÈíÆÂÖ∂‰ªñÂå∫Âüü');
                        this.createNewChat();
                    }
                });
            }

            expand() {
                appState.sidebarCollapsed = false;
                this.sidebar.classList.remove('collapsed');

                // ‰øùÂ≠òÁä∂ÊÄÅÂà∞Êú¨Âú∞Â≠òÂÇ®
                appState.save();
            }

            toggle() {
                appState.sidebarCollapsed = !appState.sidebarCollapsed;
                this.sidebar.classList.toggle('collapsed');

                // ÂêåÊó∂ÂàáÊç¢‰∏ªÈ°µÈù¢ÁöÑÂ±Ö‰∏≠Ê†∑Âºè
                const mainPage = document.getElementById('main-page');
                if (appState.sidebarCollapsed) {
                    mainPage.classList.add('sidebar-hidden');
                } else {
                    mainPage.classList.remove('sidebar-hidden');
                }

                // ‰øùÂ≠òÁä∂ÊÄÅÂà∞Êú¨Âú∞Â≠òÂÇ®
                appState.save();
            }

            bindNewChat() {
                const newChatBtn = document.getElementById('new-chat-btn');
                const newChatBtnMini = document.getElementById('new-chat-btn-mini');

                newChatBtn.addEventListener('click', () => {
                    this.createNewChat();
                });

                newChatBtnMini.addEventListener('click', () => {
                    this.createNewChat();
                });
            }

            createNewChat() {
                // ËÑ±Á¶ªÂΩìÂâçÂØπËØùÔºåÂõûÂà∞‰∏ªÁïåÈù¢
                console.log('üî• createNewChat - ÈáçÁΩÆcurrentChatId‰πãÂâç:', appState.currentChatId);
                appState.currentChatId = null;
                console.log('üî• createNewChat - ÈáçÁΩÆcurrentChatId‰πãÂêé:', appState.currentChatId);
                this.showWelcomeScreen();
                this.clearMessages();

                // Ê∏ÖÈô§ÂéÜÂè≤ÂàóË°®‰∏≠ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                this.clearHistorySelection();

                // ÁßªÈô§‰∫Ü"Â∑≤ÂõûÂà∞‰∏ªÁïåÈù¢"ÁöÑÊ∂àÊÅØÊèêÁ§∫
            }

            clearHistorySelection() {
                // Ê∏ÖÈô§ÂéÜÂè≤ÂàóË°®‰∏≠ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                const historyItems = this.historyList.querySelectorAll('.history-item');
                historyItems.forEach(item => {
                    item.classList.remove('active');
                });
            }

            deleteChat(chatId) {
                console.log('üî• Âà†Èô§ÂØπËØù:', chatId);

                // Á°ÆËÆ§Âà†Èô§
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂØπËØùÂêóÔºü')) {
                    // ‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âà†Èô§
                    const chatIndex = appState.chatHistory.findIndex(c => c.id === chatId);
                    if (chatIndex !== -1) {
                        appState.chatHistory.splice(chatIndex, 1);
                        console.log('üî• ÂØπËØùÂ∑≤Âà†Èô§ÔºåÂâ©‰ΩôÂØπËØùÊï∞Èáè:', appState.chatHistory.length);

                        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØùÔºåÂõûÂà∞‰∏ªÁïåÈù¢
                        if (appState.currentChatId === chatId) {
                            console.log('üî• Âà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØùÔºåÂõûÂà∞‰∏ªÁïåÈù¢');
                            appState.currentChatId = null;
                            this.showWelcomeScreen();
                            this.clearMessages();
                        }

                        // ‰øùÂ≠òÁä∂ÊÄÅ
                        appState.saveState();

                        // ÈáçÊñ∞Ê∏≤ÊüìÂéÜÂè≤ÂàóË°®
                        this.renderChatHistory();

                        utils.showToast('ÂØπËØùÂ∑≤Âà†Èô§', 'success');
                    } else {
                        console.error('üî• Êú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÂØπËØù:', chatId);
                        utils.showToast('Âà†Èô§Â§±Ë¥•ÔºåÂØπËØù‰∏çÂ≠òÂú®', 'error');
                    }
                } else {
                    console.log('üî• Áî®Êà∑ÂèñÊ∂àÂà†Èô§');
                }
            }

            bindBrandClick() {
                // Á≠âÂæÖDOMÂÆåÂÖ®Âä†ËΩΩ
                setTimeout(() => {
                    // ‰∏∫ÊâÄÊúâbrand-infoÂÖÉÁ¥†Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    const brandInfos = document.querySelectorAll('.brand-info');
                    console.log('üî• bindBrandClick - ÊâæÂà∞brand-infoÂÖÉÁ¥†Êï∞Èáè:', brandInfos.length);
                    console.log('üî• bindBrandClick - DOMÁä∂ÊÄÅ:', document.readyState);

                    brandInfos.forEach((brandInfo, index) => {
                        console.log(`üî• brand-info ${index}:`, brandInfo);

                        brandInfo.addEventListener('click', (e) => {
                            console.log('üî• brand-infoË¢´ÁÇπÂáª:', index);
                            console.log('üî• ÁÇπÂáªÁõÆÊ†á:', e.target);

                            // Á°Æ‰øùÁÇπÂáªÁöÑ‰∏çÊòØÂÖ∂‰ªñÊåâÈíÆÊàñÂèØ‰∫§‰∫íÂÖÉÁ¥†
                            const isButton = e.target.closest('button');
                            const isUserMenu = e.target.closest('.user-menu');

                            if (!isButton && !isUserMenu) {
                                console.log('üî• Ëß¶ÂèëÊñ∞Âª∫ÂØπËØù');
                                this.createNewChat();
                            } else {
                                console.log('üî• ÁÇπÂáª‰∫ÜÊåâÈíÆÊàñÁî®Êà∑ËèúÂçïÔºå‰∏çËß¶ÂèëÊñ∞Âª∫ÂØπËØù');
                            }
                        });

                        // ‰∏∫brand-infoÂÜÖÁöÑÊâÄÊúâÂ≠êÂÖÉÁ¥†Ê∑ªÂä†Ê†∑Âºè
                        const brandElements = brandInfo.querySelectorAll('*');
                        brandInfo.style.cursor = 'pointer';
                        brandInfo.title = 'ÁÇπÂáªÊñ∞Âª∫ÂØπËØù';

                        brandElements.forEach(el => {
                            el.style.cursor = 'pointer';
                            el.title = 'ÁÇπÂáªÊñ∞Âª∫ÂØπËØù';
                        });
                    });
                }, 100); // Âª∂Ëøü100msÁ°Æ‰øùDOMÂÆåÂÖ®ÂáÜÂ§áÂ•Ω
            }

            bindUserMenu() {
                const userBtn = document.getElementById('user-menu-btn');
                const userDropdown = document.getElementById('user-dropdown');

                userBtn.addEventListener('click', () => {
                    userDropdown.classList.toggle('show');
                });

                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
                document.addEventListener('click', (e) => {
                    if (!userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('show');
                    }
                });

                // ÂèçÈ¶à‰∏éÂ∏ÆÂä©
                document.getElementById('feedback-btn').addEventListener('click', () => {
                    userDropdown.classList.remove('show');
                    this.showFeedbackModal();
                });

                // ÈÄÄÂá∫ÁôªÂΩï
                document.getElementById('logout-btn').addEventListener('click', () => {
                    userDropdown.classList.remove('show');
                    this.logout();
                });
            }

            showFeedbackModal() {
                modalManager.show(`
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">ÂèçÈ¶à‰∏éÂ∏ÆÂä©</h3>
                            <button class="modal-close">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÂèçÈ¶àÁ±ªÂûã</label>
                                <select class="form-select">
                                    <option value="bug">ÈóÆÈ¢òÂèçÈ¶à</option>
                                    <option value="suggestion">ÂäüËÉΩÂª∫ËÆÆ</option>
                                    <option value="other">ÂÖ∂‰ªñ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈóÆÈ¢òÊèèËø∞</label>
                                <textarea class="form-textarea" rows="4" placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÈÅáÂà∞ÁöÑÈóÆÈ¢òÊàñÂª∫ËÆÆ... Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°å"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ËÅîÁ≥ªÊñπÂºèÔºàÈÄâÂ°´Ôºâ</label>
                                <input type="text" class="form-input" placeholder="ÈÇÆÁÆ±ÊàñÁîµËØù">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="modalManager.close()">ÂèñÊ∂à</button>
                            <button class="btn btn-primary" onclick="sidebarManager.submitFeedback()">Êèê‰∫§</button>
                        </div>
                    </div>
                `);
            }

            submitFeedback() {
                utils.showToast('ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåÊÑüË∞¢ÊÇ®ÁöÑÂÆùË¥µÊÑèËßÅÔºÅ', 'success');
                modalManager.close();
            }

            logout() {
                if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                    appState.clearState();
                    appManager.showLoginPage();
                    utils.showToast('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 'info');
                }
            }

            loadChatHistory() {
                // ÂàùÂßãÂåñ‰æßËæπÊ†èÁä∂ÊÄÅ
                this.initializeSidebarState();
                this.renderChatHistory();
            }

            initializeSidebarState() {
                if (appState.sidebarCollapsed) {
                    this.sidebar.classList.add('collapsed');
                    // ÂêåÊó∂ËÆæÁΩÆ‰∏ªÈ°µÈù¢ÁöÑÂ±Ö‰∏≠Ê†∑Âºè
                    const mainPage = document.getElementById('main-page');
                    mainPage.classList.add('sidebar-hidden');
                }
            }

            renderChatHistory() {
                this.historyList.innerHTML = '';

                if (appState.chatHistory.length === 0) {
                    this.historyList.innerHTML = '<div class="history-item">ÊöÇÊó†ÂéÜÂè≤ÂØπËØù</div>';
                    return;
                }

                appState.chatHistory.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'history-item';
                    if (chat.id === appState.currentChatId) {
                        chatItem.classList.add('active');
                    }

                    chatItem.innerHTML = `
                        <div class="chat-content">
                            <div class="chat-title">${chat.title}</div>
                            <div class="chat-time">${utils.formatTime(chat.createdAt)}</div>
                        </div>
                        <div class="chat-actions">
                            <button class="delete-btn" data-chat-id="${chat.id}" title="Âà†Èô§ÂØπËØù">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"/>
                                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/>
                                </svg>
                            </button>
                        </div>
                    `;

                    // ÁÇπÂáªÂØπËØùÂÜÖÂÆπÂä†ËΩΩÂØπËØù
                    const chatContent = chatItem.querySelector('.chat-content');
                    chatContent.addEventListener('click', () => {
                        this.loadChat(chat.id);
                    });

                    // ÁÇπÂáªÂà†Èô§ÊåâÈíÆÂà†Èô§ÂØπËØù
                    const deleteBtn = chatItem.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                        this.deleteChat(chat.id);
                    });

                    this.historyList.appendChild(chatItem);
                });
            }

            loadChat(chatId) {
                const chat = appState.chatHistory.find(c => c.id === chatId);
                if (!chat) return;

                console.log('üî• loadChat - ÂºÄÂßãÂä†ËΩΩÂØπËØù:', chatId);
                console.log('üî• loadChat - ÂØπËØùÂÜÖÂÆπ:', chat);

                appState.currentChatId = chatId;
                this.renderChatHistory();
                this.hideWelcomeScreen();

                console.log('üî• loadChat - ÂºÄÂßãÊ∏≤ÊüìÊ∂àÊÅØÔºåÊ∂àÊÅØÊï∞Èáè:', chat.messages.length);
                this.renderMessages(chat.messages);
                console.log('üî• loadChat - Ê∂àÊÅØÊ∏≤ÊüìÂÆåÊàê');
            }

            renderMessages(messages) {
                chatManager.messagesContainer.innerHTML = '';
                console.log('üî• renderMessages - Ê∏≤ÊüìÂéÜÂè≤Ê∂àÊÅØÔºåÊï∞Èáè:', messages.length);
                messages.forEach(message => {
                    console.log('üî• renderMessages - Ê∏≤ÊüìÂéÜÂè≤Ê∂àÊÅØÔºåË∑≥ËøáÂä®Áîª:', message);
                    chatManager.addMessage(message, true); // ÂéÜÂè≤Ê∂àÊÅØË∑≥ËøáÂä®Áîª
                });
            }

            hideWelcomeScreen() {
                console.log('üî• hideWelcomeScreen ÂºÄÂßãÊâßË°å');
                const welcomeScreen = document.getElementById('welcome-screen');
                const chatContainer = document.getElementById('chat-container');
                const inputArea = document.querySelector('.input-area');

                console.log('üî• welcomeScreen:', welcomeScreen);
                console.log('üî• chatContainer:', chatContainer);

                if (welcomeScreen) {
                    console.log('üî• Ê¨¢ËøéÁïåÈù¢ÂΩìÂâçdisplay:', window.getComputedStyle(welcomeScreen).display);
                    welcomeScreen.style.display = 'none';
                    welcomeScreen.classList.remove('active'); // ÁßªÈô§activeÁ±ª
                    console.log('üî• ÈöêËóèÊ¨¢ËøéÁïåÈù¢');
                }
                if (chatContainer) {
                    console.log('üî• ËÅäÂ§©ÂÆπÂô®ÂΩìÂâçdisplay:', window.getComputedStyle(chatContainer).display);
                    chatContainer.style.display = 'flex';
                    console.log('üî• ÊòæÁ§∫ËÅäÂ§©ÂÆπÂô®');
                }

                // Âº∫Âà∂ÊÅ¢Â§çËæìÂÖ•Ê°ÜÊ†∑Âºè
                if (inputArea) {
                    console.log('üî• ÊÅ¢Â§çËæìÂÖ•Ê°ÜÊ†∑Âºè');
                    inputArea.style.setProperty('background-color', '', 'important');
                    inputArea.style.setProperty('margin-top', '', 'important');
                    inputArea.style.setProperty('padding-top', '', 'important');
                    inputArea.style.setProperty('margin-bottom', '', 'important');
                    inputArea.style.setProperty('position', '', 'important');
                    inputArea.style.setProperty('z-index', '', 'important');
                    console.log('üî• ËæìÂÖ•Ê°ÜÊ†∑ÂºèÂ∑≤ÊÅ¢Â§ç');
                }

                // Ê£ÄÊü•ËÅäÂ§©ÂÆπÂô®ÁöÑÁà∂ÂÖÉÁ¥†
                const mainContent = document.querySelector('.main-content');
                console.log('üî• main-content:', mainContent);
                if (mainContent) {
                    console.log('üî• main-content display:', window.getComputedStyle(mainContent).display);
                }
            }

            showWelcomeScreen() {
                const welcomeScreen = document.getElementById('welcome-screen');
                const chatContainer = document.getElementById('chat-container');

                console.log('üî• showWelcomeScreen ÂºÄÂßãÊâßË°å');
                console.log('üî• welcomeScreen:', welcomeScreen);

                if (welcomeScreen) {
                    welcomeScreen.style.display = 'flex';
                    welcomeScreen.classList.add('active'); // Ê∑ªÂä†activeÁ±ª
                    console.log('üî• Ê¨¢ËøéÁïåÈù¢Â∑≤ÊøÄÊ¥ª');
                }
                if (chatContainer) chatContainer.style.display = 'none';

                // Âª∂ËøüËÆæÁΩÆËæìÂÖ•Ê°ÜÊ†∑ÂºèÔºåÁ°Æ‰øùDOMÊõ¥Êñ∞ÂÆåÊàê
                setTimeout(() => {
                    const inputArea = document.querySelector('.input-area');
                    if (inputArea) {
                        console.log('üî• showWelcomeScreen ÂºÄÂßãËÆæÁΩÆËæìÂÖ•Ê°ÜÊ†∑Âºè');

                        // ÂÖàÂº∫Âà∂Ê∏ÖÈô§ÊâÄÊúâÂèØËÉΩÁöÑÊ†∑Âºè
                        inputArea.style.cssText = '';

                        // ‰øùÊåÅËæìÂÖ•Ê°ÜÂú®ÂéüÂßã‰ΩçÁΩÆÔºåÂè™Ë∞ÉÊï¥ÂÜÖÈÉ®Ê†∑Âºè
                        inputArea.style.setProperty('background-color', 'transparent', 'important');
                        inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ‰∏ãË∞É50pxÔºåË∞ÉÊï¥‰∏∫-250px */
                        inputArea.style.setProperty('padding-top', '0', 'important');
                        inputArea.style.setProperty('padding-bottom', '0', 'important');
                        inputArea.style.setProperty('margin-bottom', '0', 'important');

                        console.log('üî• showWelcomeScreen ËæìÂÖ•Ê°ÜÊ†∑ÂºèÂ∑≤ËÆæÁΩÆ');
                        console.log('üî• ÂΩìÂâçmarginTop:', inputArea.style.marginTop);

                        // È™åËØÅËÆ°ÁÆóÊ†∑Âºè
                        const computedStyle = window.getComputedStyle(inputArea);
                        console.log('üî• ËÆ°ÁÆóÂêéÁöÑmarginTop:', computedStyle.marginTop);
                    } else {
                        console.error('üî• showWelcomeScreen Êâæ‰∏çÂà∞ËæìÂÖ•Ê°ÜÂÖÉÁ¥†ÔºÅ');
                    }
                }, 100);
            }

            clearMessages() {
                chatManager.messagesContainer.innerHTML = '';
            }
        }

        // ‰∏ªÂ∫îÁî®ÁÆ°ÁêÜ
        class AppManager {
            constructor() {
                this.loginPage = document.getElementById('login-page');
                this.mainPage = document.getElementById('main-page');
                this.init();
            }

            init() {
                // Âä†ËΩΩ‰øùÂ≠òÁöÑÁä∂ÊÄÅ
                appState.loadState();

                // ÂàùÂßãÂåñÂêÑ‰∏™ÁÆ°ÁêÜÂô®
                window.modalManager = new ModalManager();
                window.loginManager = new LoginManager();
                window.welcomeManager = new WelcomeManager();
                window.sidebarManager = new SidebarManager();
                window.chatManager = new ChatManager();

                // Ê†πÊçÆÁôªÂΩïÁä∂ÊÄÅÊòæÁ§∫ÂØπÂ∫îÈ°µÈù¢
                if (appState.isLoggedIn) {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÈ°µÈù¢Âà∑Êñ∞ÔºàÈÄöËøáÊ£ÄÊü•performance.navigationÊàñÂÖ∂‰ªñÊñπÂºèÔºâ
                    const isPageRefresh = performance.getEntriesByType &&
                                         performance.getEntriesByType('navigation').length > 0 &&
                                         performance.getEntriesByType('navigation')[0].type === 'reload';

                    console.log('üî• È°µÈù¢Âä†ËΩΩÁ±ªÂûã:', isPageRefresh ? 'Âà∑Êñ∞' : 'È¶ñÊ¨°Âä†ËΩΩ');
                    this.showMainPage(isPageRefresh);
                } else {
                    this.showLoginPage();
                }

                // ÁªëÂÆöÂÖ®Â±Ä‰∫ã‰ª∂
                this.bindGlobalEvents();
            }

            bindGlobalEvents() {
                // ÂìçÂ∫îÂºèÂ§ÑÁêÜ
                window.addEventListener('resize', utils.debounce(() => {
                    this.handleResize();
                }, 250));

                // Â§áÁî®logoÁÇπÂáª‰∫ã‰ª∂ÁªëÂÆöÔºàÁ°Æ‰øùÈ°µÈù¢Âà∑Êñ∞Âêé‰πüËÉΩÂ∑•‰ΩúÔºâ
                setTimeout(() => {
                    this.bindBrandClickGlobal();
                }, 200);

                // ÈîÆÁõòÂø´Êç∑ÈîÆ
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboardShortcuts(e);
                });
            }

            handleResize() {
                // ÂìçÂ∫îÂºèÈÄªËæë
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.add('collapsed');
                        appState.sidebarCollapsed = true;
                    }
                }
            }

            handleKeyboardShortcuts(e) {
                // Ctrl/Cmd + N Êñ∞Âª∫ÂØπËØù
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    if (window.sidebarManager) {
                        window.sidebarManager.createNewChat();
                    }
                }
            }

            bindBrandClickGlobal() {
                // ÂÖ®Â±ÄÂ§áÁî®ÁöÑlogoÁÇπÂáª‰∫ã‰ª∂ÁªëÂÆö
                const brandInfos = document.querySelectorAll('.brand-info');
                console.log('üî• bindBrandClickGlobal - ÂÖ®Â±ÄÁªëÂÆölogoÁÇπÂáª‰∫ã‰ª∂ÔºåÊâæÂà∞ÂÖÉÁ¥†Êï∞Èáè:', brandInfos.length);

                brandInfos.forEach((brandInfo, index) => {
                    // ÁßªÈô§‰πãÂâçÂèØËÉΩÂ≠òÂú®ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    if (brandInfo._brandClickHandler) {
                        brandInfo.removeEventListener('click', brandInfo._brandClickHandler);
                    }

                    // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    const clickHandler = (e) => {
                        console.log('üî• ÂÖ®Â±Äbrand-infoË¢´ÁÇπÂáª:', index);
                        console.log('üî• ÁÇπÂáªÁõÆÊ†á:', e.target);

                        // Á°Æ‰øùÁÇπÂáªÁöÑ‰∏çÊòØÂÖ∂‰ªñÊåâÈíÆÊàñÂèØ‰∫§‰∫íÂÖÉÁ¥†
                        const isButton = e.target.closest('button');
                        const isUserMenu = e.target.closest('.user-menu');

                        if (!isButton && !isUserMenu) {
                            console.log('üî• ÂÖ®Â±ÄËß¶ÂèëÊñ∞Âª∫ÂØπËØù');
                            if (window.sidebarManager) {
                                window.sidebarManager.createNewChat();
                            } else {
                                console.error('üî• sidebarManager ‰∏çÂ≠òÂú®');
                            }
                        } else {
                            console.log('üî• ÁÇπÂáª‰∫ÜÊåâÈíÆÊàñÁî®Êà∑ËèúÂçïÔºå‰∏çËß¶ÂèëÊñ∞Âª∫ÂØπËØù');
                        }
                    };

                    brandInfo.addEventListener('click', clickHandler);

                    // ‰øùÂ≠òÂ§ÑÁêÜÂô®ÂºïÁî®‰ª•‰æøÂêéÁª≠Ê∏ÖÁêÜ
                    brandInfo._brandClickHandler = clickHandler;

                    // Á°Æ‰øùÊ†∑ÂºèÊ≠£Á°Æ
                    brandInfo.style.cursor = 'pointer';
                    brandInfo.title = 'ÁÇπÂáªÊñ∞Âª∫ÂØπËØù';

                    const brandElements = brandInfo.querySelectorAll('*');
                    brandElements.forEach(el => {
                        el.style.cursor = 'pointer';
                        el.title = 'ÁÇπÂáªÊñ∞Âª∫ÂØπËØù';
                    });
                });
            }

            showLoginPage() {
                if (this.loginPage) this.loginPage.classList.add('active');
                if (this.mainPage) this.mainPage.classList.remove('active');
                appState.currentPage = 'login';
            }

            showMainPage(isPageRefresh = false) {
                if (this.loginPage) this.loginPage.classList.remove('active');
                if (this.mainPage) this.mainPage.classList.add('active');
                appState.currentPage = 'main';

                // ËÆæÁΩÆÁî®Êà∑ÂêçÊòæÁ§∫
                const userNameEl = document.getElementById('user-name');
                if (userNameEl) userNameEl.textContent = appState.userName;

                // ËÆæÁΩÆÊ∑±Â∫¶ÊÄùËÄÉÂºÄÂÖ≥Áä∂ÊÄÅ - ÂêåÊ≠•ÂéüËæìÂÖ•Ê°ÜÂíåÊñ∞ËæìÂÖ•Ê°Ü
                const deepThinkingEl = document.getElementById('deep-thinking-checkbox');
                const welcomeDeepThinkingEl = document.getElementById('welcome-deep-thinking-checkbox');
                if (deepThinkingEl) deepThinkingEl.checked = appState.deepThinkingEnabled;
                if (welcomeDeepThinkingEl) welcomeDeepThinkingEl.checked = appState.deepThinkingEnabled;

                // Á°Æ‰øùÊ¨¢ËøéÁïåÈù¢ÂàùÂßãÁä∂ÊÄÅÊ≠£Á°ÆÂπ∂ËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆ
                const welcomeScreen = document.getElementById('welcome-screen');
                if (welcomeScreen) {
                    welcomeScreen.style.display = 'flex';
                    welcomeScreen.classList.add('active');
                    console.log('üî• showMainPage ÊøÄÊ¥ªÊ¨¢ËøéÁïåÈù¢');

                    // Âª∂ËøüËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆÔºåÁ°Æ‰øùDOMÊõ¥Êñ∞ÂÆåÊàê
                    setTimeout(() => {
                        const inputArea = document.querySelector('.input-area');
                        if (inputArea) {
                            console.log('üî• showMainPage ÂºÄÂßãËÆæÁΩÆËæìÂÖ•Ê°ÜÊ†∑Âºè');

                            // ÂÖàÂº∫Âà∂Ê∏ÖÈô§ÊâÄÊúâÂèØËÉΩÁöÑÊ†∑Âºè
                            inputArea.style.cssText = '';

                            // ËÆæÁΩÆËæìÂÖ•Ê°Ü‰ΩçÁΩÆ
                            inputArea.style.setProperty('background-color', 'transparent', 'important');
                            inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ‰∏ãË∞É50pxÔºåË∞ÉÊï¥‰∏∫-250px */
                            inputArea.style.setProperty('padding-top', '0', 'important');
                            inputArea.style.setProperty('padding-bottom', '0', 'important');
                            inputArea.style.setProperty('margin-bottom', '0', 'important');

                            console.log('üî• showMainPage ËæìÂÖ•Ê°ÜÊ†∑ÂºèÂ∑≤ËÆæÁΩÆ');
                            console.log('üî• ËÆæÁΩÆÂêéÁöÑmarginTop:', inputArea.style.marginTop);
                        } else {
                            console.error('üî• showMainPage Êâæ‰∏çÂà∞inputAreaÂÖÉÁ¥†ÔºÅ');
                        }
                    }, 200); // Â¢ûÂä†Âª∂ËøüÊó∂Èó¥Á°Æ‰øùDOMÂÆåÂÖ®Êõ¥Êñ∞
                } else {
                    console.error('üî• showMainPage Êâæ‰∏çÂà∞welcomeScreenÂÖÉÁ¥†ÔºÅ');
                }

                // Â¶ÇÊûúÊòØÈ°µÈù¢Âà∑Êñ∞ÔºåËá™Âä®ÂàõÂª∫Êñ∞ÂØπËØùÔºàÁ±ª‰ººÁÇπÂáªÊñ∞Âª∫ÂØπËØùÊåâÈíÆÔºâ
                if (isPageRefresh) {
                    console.log('üî• È°µÈù¢Âà∑Êñ∞ÔºåËá™Âä®ÂàõÂª∫Êñ∞ÂØπËØù');
                    setTimeout(() => {
                        if (window.sidebarManager) {
                            window.sidebarManager.createNewChat();
                        } else {
                            console.error('üî• sidebarManager ‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÂàõÂª∫Êñ∞ÂØπËØù');
                        }
                    }, 100); // Á®çÂæÆÂª∂ËøüÁ°Æ‰øùÊâÄÊúâÁªÑ‰ª∂ÈÉΩÂàùÂßãÂåñÂÆåÊàê
                }
            }
        }

        // ÂêØÂä®Â∫îÁî®
        let appManager;

        document.addEventListener('DOMContentLoaded', () => {
            appManager = new AppManager();
            window.appManager = appManager;
            console.log('AI‰∫ßÂìÅ‰∏ìÂÆ∂ Demo Â∑≤ÂêØÂä®');

            // ‰ºòÂåñÁöÑÂÖ®Â±ÄÁõëÂê¨Âô®ÔºöÁ°Æ‰øùËæìÂÖ•Ê°Ü‰ΩçÁΩÆÊ≠£Á°ÆÔºåÈÅøÂÖçÈáçÂ§çËÆæÁΩÆ
            let lastWelcomeScreenState = false;
            setInterval(() => {
                const welcomeScreen = document.getElementById('welcome-screen');
                const inputArea = document.querySelector('.input-area');

                // Êõ¥ÂáÜÁ°ÆÁöÑÊ¨¢ËøéÁïåÈù¢Áä∂ÊÄÅÊ£ÄÊµã
                const isWelcomeScreenVisible = welcomeScreen &&
                    welcomeScreen.style.display !== 'none' &&
                    !welcomeScreen.classList.contains('hidden') &&
                    welcomeScreen.classList.contains('active');

                // Âè™Âú®Ê¨¢ËøéÁïåÈù¢Áä∂ÊÄÅÂèòÂåñÊó∂ËÆæÁΩÆÊ†∑Âºè
                if (isWelcomeScreenVisible !== lastWelcomeScreenState && inputArea) {
                    lastWelcomeScreenState = isWelcomeScreenVisible;

                    if (isWelcomeScreenVisible) {
                        console.log('üî• Ê¨¢ËøéÁïåÈù¢ÊòæÁ§∫ÔºåË∞ÉÊï¥ËæìÂÖ•Ê°ÜÊ†∑Âºè');
                        inputArea.style.setProperty('background-color', 'transparent', 'important');
                        inputArea.style.setProperty('margin-top', '-250px', 'important'); /* ‰∏ãË∞É50pxÔºåË∞ÉÊï¥‰∏∫-250px */
                        inputArea.style.setProperty('padding-top', '0', 'important');
                        inputArea.style.setProperty('padding-bottom', '0', 'important');
                        inputArea.style.setProperty('margin-bottom', '0', 'important');
                    } else {
                        console.log('üî• Ê¨¢ËøéÁïåÈù¢ÈöêËóèÔºåÊÅ¢Â§çËæìÂÖ•Ê°ÜÊ†∑Âºè');
                        inputArea.style.cssText = ''; // Ê∏ÖÈô§ÊâÄÊúâËÆæÁΩÆ
                    }
                }

                // È¢ùÂ§ñÊ£ÄÊü•ÔºöÂ¶ÇÊûúÊòØÁôªÂΩïÂêéÂàöÂºÄÂßãÔºåÂº∫Âà∂ËÆæÁΩÆ‰∏ÄÊ¨°
                if (isWelcomeScreenVisible && inputArea && lastWelcomeScreenState === false) {
                    console.log('üî• Âº∫Âà∂Ê£ÄÊü•ÔºöÊ¨¢ËøéÁïåÈù¢ÊòæÁ§∫‰ΩÜ‰∏äÊ¨°Áä∂ÊÄÅ‰∏∫falseÔºåÈáçÊñ∞ËÆæÁΩÆËæìÂÖ•Ê°ÜÊ†∑Âºè');
                    // ‰ΩøÁî®cssTextÁ°Æ‰øùÂÆåÂÖ®Ë¶ÜÁõñ
                    inputArea.style.cssText = `
                        margin-top: -250px !important;
                        background-color: transparent !important;
                        padding-top: 0 !important;
                        padding-bottom: 0 !important;
                        margin-bottom: 0 !important;
                    `;
                    lastWelcomeScreenState = true;
                }
            }, 200); // Â¢ûÂä†Ê£ÄÊü•È¢ëÁéáÔºåÊØè200msÊ£ÄÊü•‰∏ÄÊ¨°
        });
    </script>
    <!-- Ê∑ªÂä†jsPDFÂ∫ìÁî®‰∫éPDFÂØºÂá∫ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
